"use strict";(self.webpackChunk_amzn_sagemaker_gen_ai_jupyterlab_extension=self.webpackChunk_amzn_sagemaker_gen_ai_jupyterlab_extension||[]).push([[930],{930:(e,t,o)=>{o.r(t),o.d(t,{FlareWidget:()=>S,connectWebSocket:()=>I,createFlarePanel:()=>L,default:()=>M});var n=o(586),a=o(310),s=o(269),r=o(256),i=o(744);const c="flare-iframe",d={position:{line:0,character:0}},l={HELP:"/help",FIX:"/fix",EXPLAIN:"/explain",OPTIMIZE:"/optimize",REFACTOR:"/refactor"},m="code",h=e=>{const t=e.currentWidget;return t?t.content.activeCell:void 0},g=e=>{const t=h(e);if(t&&t.model.type===m){const e=t.model.outputs;if(e)for(let t=0;t<e.length;t++)if("error"===e.get(t).type)return!0}return!1},p=(e,t)=>{var o;if("Fix"===t&&g(e)){const t=e.currentWidget,n=(null===(o=null==t?void 0:t.content.activeCell)||void 0===o?void 0:o.model.type)===m?t.content.activeCell.model.sharedModel.getSource():"",a=(e=>{var t;const o=h(e);if(o&&o.model.type===m){const e=o.model.outputs;if(e)for(let o=0;o<e.length;o++){const n=e.get(o);if("error"===n.type)return`ErrorType: ${n._raw.ename}; ErrorValue: ${n._raw.evalue}; Trace: ${null===(t=n._raw.traceback)||void 0===t?void 0:t.toString()}`}}return""})(e);return`Code:\n${n}\n\nError:\n${a}`}const n=h(e);if(n&&n.model.type===m){const e=n.editor;if(e){const t=e.getSelection();if(t.start.line!==t.end.line||t.start.column!==t.end.column){const o=e.model.sharedModel.getSource().substring(e.getOffsetAt(t.start),e.getOffsetAt(t.end));if(o.trim())return o}}return n.model.sharedModel.getSource()}return""},u=e=>{const t=document.getElementById(c);if(!t||!t.contentWindow)throw new Error("Q Chat UI not mounted");t.contentWindow.postMessage(e,window.location.origin)};class w{sendErrorToWebview(e,t,o){u({command:"errorMessage",params:{title:e,message:t,tabId:o}})}constructor({url:e,docManager:t,reconnectInterval:o=1e3,timeout:n=6e5}){this.pendingRequests=new Map,this.url=e,this.reconnectInterval=o,this.timeout=n,this.docManager=t,this.setupSocket()}startHeartbeat(){this.heartbeatInterval=setInterval((()=>{this.sendNotification({command:"ping",params:{}})}),2e4)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=void 0)}setupSocket(e=3){var t;return(null===(t=this.socket)||void 0===t?void 0:t.readyState)===WebSocket.OPEN?Promise.resolve(!0):(this.connectionPromise||(this.connectionPromise=new Promise((t=>{let o=0;const n=()=>{if(o>=e)return this.connectionPromise=void 0,void t(!1);o++,console.log(`Attempting to connect, attempt #${o}`);const a=new WebSocket(this.url);a.onopen=()=>{console.log("WebSocket connection established"),this.socket=a,this.socket.onmessage=this.onMessage.bind(this),this.startHeartbeat(),this.socket.onerror=e=>console.error("WebSocket error:",e),this.socket.onclose=e=>{console.log("WebSocket connection closed:",e.code,e.reason),this.stopHeartbeat(),this.connectionPromise=void 0,this.setupSocket(5)},this.connectionPromise=void 0,t(!0)},a.onerror=()=>{const e=this.reconnectInterval*Math.pow(2,o-1);setTimeout(n,e)}};n()}))),this.connectionPromise)}onMessage(e){if(!e.origin||e.origin.startsWith("wss://"))if(e.origin&&e.origin.replace("wss://","")!==window.location.origin.replace("https://",""))console.warn(`Rejected message from unauthorized origin: ${e.origin}`);else try{const t=JSON.parse(e.data),o=t.id;if(console.log("WebSocket message received:",t),o){const e=this.pendingRequests.get(o);e?e(t):console.warn(`No handler found for message with id: ${o}`)}else this.handleInboundEvent(t)}catch(t){console.error("Error processing message:",t);const o=JSON.parse(e.data);this.sendErrorToWebview("Message Processing Error","Failed to process message, please refresh browser and try again.",o.tabId)}else console.warn(`Rejected message from insecure websocket connection: ${e.origin}`)}handleInboundEvent(e){try{const t=e.command;switch(console.log("Handling inbound event:",{command:t}),t){case"aws/chat/sendChatPrompt":case"aws/chat/buttonClick":case"aws/chat/sendPinnedContext":case"aws/chat/openTab":case"aws/chat/sendChatUpdate":case"aws/chat/chatOptionsUpdate":u(e);break;case"aws/chat/sendContextCommands":const o=["Folders","Files"],n=e.params.contextCommandGroups.map((e=>{const t=null==e?void 0:e.commands.filter((e=>o.includes(e.command)));return{...e,commands:t}}));u({...e,params:{...e.params,contextCommandGroups:n}});break;case"aws/openFileDiff":this.docManager.openOrReveal(e.params.originalFileUri.replace("home/sagemaker-user/",""));break;case"ping":console.log("Received ping");break;default:console.log(`Unhandled inbound command: ${t}`)}}catch(t){console.error("Error handling event:",t),this.sendErrorToWebview("Event Handling Error","Failed to handle inbound event, please refresh browser and try again.",e.tabId)}}async sendRequest(e){if(!await this.setupSocket())return this.sendErrorToWebview("Connection Error","WebSocket is not connected, please refresh your page.",e.tabId),Promise.reject(new Error("WebSocket is not connected"));const t=(0,i.v4)();return console.log(`Sending request with id: ${t}, command: ${e.command}`),new Promise(((o,n)=>{const a=setTimeout((()=>{this.pendingRequests.delete(t),console.error(`Request timed out: ${e.command} (id: ${t})`),this.sendErrorToWebview("Request Timeout",`Request timed out: ${e.command}`,e.tabId),n(new Error(`Request timed out: ${e.command}`))}),this.timeout);this.pendingRequests.set(t,(s=>{clearTimeout(a),this.pendingRequests.delete(t),s.error?(s.error.toLowerCase().includes("you are not subscribed to amazon q developer")?this.sendErrorToWebview("No active subscription",s.error,e.tabId):s.error.includes("Something went wrong")?this.sendErrorToWebview("Internal Server Error",s.error,e.tabId):this.sendErrorToWebview("Response Error",s.error,e.tabId),n(new Error(s.error))):(console.log(`Received response for id: ${t}`),o(s))}));try{const o={...e,id:t};console.log("Sending payload:",o),this.socket.send(JSON.stringify(o))}catch(o){clearTimeout(a),this.pendingRequests.delete(t),this.sendErrorToWebview("Message Sending Error","Failed to send message, please refresh browser and try again.",e.tabId),n(o)}}))}async sendNotification(e){return!!await this.setupSocket()&&(console.log(`Sending notification: ${e.command}`),this.socket.send(JSON.stringify(e)),!0)}}const b=new(o(159).LabIcon)({name:"sagemaker_gen_ai_jupyterlab_extension:q-icon",svgstr:'<svg width="256" height="256" viewBox="0 0 256 256" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M227.84 52.985L142.93 3.975C133.63 -1.325 122.13 -1.325 112.92 3.975L28 52.985C18.7 58.385 13 68.285 13 78.985V177.005C13 187.705 18.7 197.605 28 203.015L112.92 252.025C122.12 257.325 133.62 257.325 142.93 252.025L227.85 203.015C237.15 197.715 242.85 187.715 242.85 177.005V78.985C242.85 68.285 237.15 58.385 227.85 52.975L227.84 52.985ZM222.84 171.205L149.53 128.895V118.895C149.53 116.795 148.43 114.795 146.53 113.695L130.93 104.695C129.03 103.595 126.83 103.595 124.93 104.695L109.33 113.695C107.43 114.795 106.33 116.795 106.33 118.895V136.895C106.33 138.995 107.43 140.995 109.33 142.095L124.93 151.095C126.83 152.195 129.03 152.195 130.93 151.095L139.53 146.095L212.74 188.405L132.92 234.515C129.82 236.315 126.02 236.315 122.92 234.515L38 185.505C34.9 183.705 33 180.405 33 176.805V78.785C33 75.185 34.9 71.885 38 70.085L122.92 21.275C126.02 19.475 129.82 19.475 132.92 21.275L217.84 70.285C220.94 72.085 222.84 75.385 222.84 78.985V171.205Z" fill="#616161"/>\n</svg>'});var f=o(531),v=o(427),k=o(851),C=o.n(k);class y{constructor(e,t){this.app=e,this.chatPanel=t,this.messageListener=async e=>{this.isMessageOriginValid(e)&&("MD_TOGGLE_AI_CHAT"!==e.data||this.toggleQChat(this.app,this.chatPanel))}}async initialize(){window.addEventListener("message",this.messageListener)}isMessageOriginValid(e){return["https://**.v2.*.beta.app.*.aws.dev","https://**.ui.*.aws.dev","https://**.v2.*-gamma.*.on.aws","https://**.datazone.*.on.aws","https://**.sagemaker.*.on.aws","https://**.sagemaker-gamma.*.on.aws"].some((t=>C()(t)(e.origin)))}toggleQChat(e,t){const o=t.id;if(!o)throw new Error("Chat widget not found.");if(e.shell instanceof n.LabShell){const t=Array.from(e.shell.widgets("left")),n=Array.from(e.shell.widgets("right")),a=[...t,...n].find((e=>e.id===o));a&&(a.isHidden?e.shell.activateById(o):n.find((e=>e.id===o))?e.shell.collapseRight():e.shell.collapseLeft())}}}var E=o(361);function I(e="",t){const o=s.ServerConnection.makeSettings(),n=a.URLExt.join(o.wsUrl,"sagemaker_gen_ai_jupyterlab_extension",e);return new w({url:n,docManager:t})}class S extends r.Widget{constructor(){super(),console.log("Creating Q Widget"),this.addClass("jp-FlareWidget"),this.node.style.height="100%",this.node.style.overflow="hidden";const e=document.createElement("div");e.id="jp-FlareContainer",e.style.width="100%",e.style.height="100%",this.node.appendChild(e)}onAfterAttach(){console.log("Q Widget attached"),this.loadContent()}async loadContent(){const e=document.getElementById("jp-FlareContainer");if(e)try{const t=document.createElement("iframe");t.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms allow-popups");const o=s.ServerConnection.makeSettings().baseUrl;t.src=a.URLExt.join(o,"sagemaker_gen_ai_jupyterlab_extension","static","client.html"),t.style.width="100%",t.style.height="100%",t.style.border="none",t.referrerPolicy="no-referrer",t.id=c,e.innerHTML="",e.appendChild(t)}catch(t){e.innerHTML=`<h2>Error Loading Amazon Q Chat</h2><p>${t}</p>`}}}function L(){console.log("Creating Q Panel");const e=new r.Panel;e.id="flare-panel",e.title.icon=b,e.title.caption="Amazon Q AI Assistant",e.title.closable=!0;const t=new S;return e.addWidget(t),e}const _={id:"@amzn/sagemaker_gen_ai_jupyterlab_extension:plugin",autoStart:!0,requires:[n.ILabShell,v.IDocumentManager,f.INotebookTracker,E.ISettingRegistry],optional:[],activate:async(e,t,o,n,a)=>{console.log("JupyterLab sagemaker_gen_ai_jupyterlab extension activated!",(new Date).toISOString());const s=I("ws",o);if(!s)return void console.error("Failed to initialize WebSocket connection. Extension functionality will be limited.");let i=null;const c=()=>{try{if(!i){if(i=L(),!i)return void console.error("Failed to create Q panel");t.add(i,"left",{rank:1/0})}t.activateById(i.id)}catch(e){console.error("Error showing Q widget:",e)}};try{(({app:e,notebookTracker:t,showFlareWidget:o})=>{const n=["Explain","Refactor","Fix","Optimize"];n.forEach((n=>{const a=`sagemaker-gen-ai:${n.toLowerCase()}`;e.commands.addCommand(a,{label:`${n}`,isEnabled:()=>"Fix"!==n||g(t),execute:()=>{const e=p(t,n);e&&(console.log(`${n}:`,e),o(),u({command:"genericCommand",params:{genericCommand:n,selection:e,triggerType:"contextMenu"}}))}})}));const a=new r.Menu({commands:e.commands});a.title.label="Amazon Q",n.forEach((e=>{a.addItem({command:`sagemaker-gen-ai:${e.toLowerCase()}`})})),[".jp-CodeCell"].forEach((t=>e.contextMenu.addItem({type:"submenu",submenu:a,selector:t,rank:0})))})({app:e,notebookTracker:n,showFlareWidget:c})}catch(e){console.error("Failed to register context menu actions:",e)}(async({socket:e,settingRegistry:t,pluginId:o})=>{null==t||t.load(o).then((t=>{null==t||t.changed.connect((()=>{e.sendNotification({command:"workspace/didChangeConfiguration",params:{}})}))}))})({socket:s,settingRegistry:a,pluginId:_.id}),setTimeout((()=>{try{i=L(),i?(t.add(i,"left",{rank:1/0}),new y(e,i).initialize(),function(e,t,o,n,a){t.addEventListener("message",(async t=>{var s;const r=t.data,i=r.command,c=null===(s=r.params)||void 0===s?void 0:s.tabId;switch(i){case"aws/chat/sendChatPrompt":try{const t=(({docManager:e,labShell:t})=>{const o=t.currentWidget;if(!o)return;const n=e.contextForWidget(o);return n&&n.path?{path:n.path}:void 0})({docManager:n,labShell:a}),o=await e.sendRequest({...r,tabId:c,params:{...r.params,textDocument:t?{uri:`file:///home/sagemaker-user/${null==t?void 0:t.path}`}:void 0,cursorState:[d]}});u(o)}catch(e){console.error(e)}break;case"aws/chat/buttonClick":case"aws/chat/listMcpServers":case"aws/chat/mcpServerClick":case"aws/chat/listConversations":case"aws/chat/listRules":case"aws/chat/conversationClick":try{const t=await e.sendRequest({...r,tabId:c});u(t)}catch(e){console.error(e)}break;case"aws/chat/ready":{e.sendNotification(r),u({command:"chatOptions",params:{mcpServers:!0,history:!0}});const t={command:"aws/chat/mcpServerClick",params:{id:"refresh-mcp-list"}};window.postMessage(t,"*")}break;case"aws/chat/sendChatQuickAction":try{const t=await e.sendRequest({...r,tabId:c}),n=r.params.quickAction;if(n===l.HELP)return void u({...t,command:"aws/chat/sendChatPrompt"});if("string"==typeof n&&[l.FIX,l.EXPLAIN,l.OPTIMIZE,l.REFACTOR].includes(n)){const e=n.slice(1);u({command:"genericCommand",params:{genericCommand:e,selection:r.params.prompt||p(o,"fix"===e?"Fix":void 0),triggerType:"contextMenu"}})}}catch(e){console.error(e)}break;case"aws/chat/tabAdd":case"aws/chat/tabChange":case"aws/chat/tabRemove":case"aws/chat/pinnedContextAdd":case"aws/chat/pinnedContextRemove":case"aws/chat/createPrompt":case"aws/chat/fileClick":case"stopChatResponse":case"aws/chat/openTab":case"aws/chat/promptInputOptionChange":e.sendNotification(r);break;case"chatPromptOptionAcknowledged":case"disclaimerAcknowledged":(e=>{"disclaimerAcknowledged"===e&&localStorage.setItem("disclaimerAcknowledged","true"),"chatPromptOptionAcknowledged"===e&&localStorage.setItem("chatPromptOptionAcknowledged","true")})(i);break;case"aws/chat/linkClick":case"aws/chat/infoLinkClick":const t={type:"openLink",url:r.params.link};window.parent.postMessage(t,"*");break;case"insertToCursorPosition":if(o&&r.params){const e=r.params.code;e&&((e,t)=>{const o=h(e);if(o&&o.model.type===m){const e=o.editor;if(e)try{const o=e.getCursorPosition(),n=e.model.sharedModel.source,a=n.substring(0,e.getOffsetAt(o)),s=a+t+n.substring(e.getOffsetAt(o));e.model.sharedModel.source=s;const r=e.getPositionAt(a.length+t.length);r&&e.setCursorPosition(r)}catch(e){console.error("Error inserting the code:",e)}}})(o,e)}}}))}(s,window,n,o,t),(()=>{const e=["mcpServers"].reduce(((e,t)=>(e[t]=!0,e)),{});u({command:"chatOptions",params:e})})()):console.error("Failed to create initial Q panel")}catch(e){console.error("Error during delayed initialization:",e)}}),5e3)}},M=_}}]);