when:
  - event: [push]

steps:
  - name: build-and-test
    image: cont-reg.bjodah.se:443/bjodah/triceratops-4:25
    environment:
      - PYTHONMALLOC=malloc
    commands:
      - bash -l ./scripts/ci.sh --cov pycompilation --cov-report html
      - bash -lc 'source $(compgen -G /opt-3/cpython-v3.*-apt-deb/bin/activate); ./scripts/generate_docs.sh'
      - ./scripts/prepare_deploy.sh
