# 示例：为你的 MCP 服务器项目设置 GitHub Actions
# 将此文件保存为 .github/workflows/build.yml

name: Build MCP Server

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_platform:
        description: 'Platform to build for'
        required: false
        default: 'native'
        type: choice
        options:
        - native
        - linux
        - windows
        - all

jobs:
  build:
    strategy:
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            python-version: '3.11'
          # Windows x86_64
          - os: windows-latest
            platform: windows
            arch: x86_64
            python-version: '3.11'
          # macOS Intel x86_64
          - os: macos-13
            platform: macos
            arch: x86_64
            python-version: '3.11'
          # macOS Apple Silicon ARM64 (M1/M2)
          - os: macos-latest
            platform: macos
            arch: arm64
            python-version: '3.11'
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install MCP Framework
      run: |
        python -m pip install --upgrade pip
        pip install mcp-framework
    
    - name: Install project dependencies (if you have requirements.txt)
      run: |
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      shell: bash
    
    # 替换 'your_server.py' 为你的实际服务器文件名
    - name: Build MCP Server
      run: |
        mcp-build --platform native --server your_server.py --no-test
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: mcp-server-${{ matrix.platform }}-${{ matrix.arch }}
        path: dist/
        retention-days: 30
    
    - name: List built files
      run: |
        echo "Built files for ${{ matrix.platform }}-${{ matrix.arch }}:"
        ls -la dist/

  # 可选：自动发布到 GitHub Releases
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          mcp-server-linux-x86_64/**/*
          mcp-server-windows-x86_64/**/*
          mcp-server-macos-x86_64/**/*
          mcp-server-macos-arm64/**/*
        draft: false
        prerelease: false
        body: |
          ## MCP Server Release
          
          Cross-platform builds for:
          - Linux x86_64
          - Windows x86_64  
          - macOS Intel (x86_64)
          - macOS Apple Silicon (ARM64/M1/M2)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 可选：Docker 跨平台构建测试
  docker-build:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install MCP Framework
      run: |
        python -m pip install --upgrade pip
        pip install mcp-framework
    
    # 替换 'your_server.py' 为你的实际服务器文件名
    - name: Test Docker cross-platform build
      run: |
        mcp-build --platform linux --server your_server.py --no-test
        mcp-build --platform windows --server your_server.py --no-test
    
    - name: Upload Docker build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: mcp-server-docker-cross-platform
        path: dist/
        retention-days: 30