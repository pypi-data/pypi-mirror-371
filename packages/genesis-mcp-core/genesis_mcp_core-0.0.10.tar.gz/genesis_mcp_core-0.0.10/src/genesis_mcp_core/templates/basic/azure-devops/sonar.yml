jobs:
- job: SonarScan
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - checkout: self
    fetchDepth: 0
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.12'
      displayName: 'Use Python 3.12'
  - script: |
      python -m pip install --upgrade pip
      pip install poetry
      poetry install
    displayName: 'Install dependencies'
  - script: |
      poetry run pytest tests/ --cov=src --cov-report=xml --cov-report=html --junitxml=test-results.xml
    displayName: 'Run tests with coverage'
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: 'test-results.xml'
      testRunTitle: 'Python Tests'
    condition: succeededOrFailed()
  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: 'coverage.xml'
      reportDirectory: 'htmlcov'
    condition: succeededOrFailed()
  - task: SonarCloudPrepare@1
    inputs:
      SonarCloud: '{{ SONAR_SERVICE_CONNECTION }}'
      organization: '{{ SONAR_ORGANIZATION }}'
      scannerMode: 'CLI'
      configMode: 'file'
  - task: SonarCloudAnalyze@1
  - task: SonarCloudPublish@1
    inputs:
      pollingTimeoutSec: '300'
