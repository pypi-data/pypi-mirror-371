<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromptMask WebUI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/barecss@1/css/bare.min.css">
    <style>
        :root { --color-accent: #007bff; --font-size: 1.1rem; }
        body { max-width: 1200px; margin: auto; padding: 1rem; }
        nav a { text-decoration: none; }
        nav a.active { font-weight: bold; text-decoration: underline; }
        /* The single <article> tag is now only used on pages that are not two-column */
        article { display: flex; flex-direction: column; gap: 1rem; }
        textarea { height: 180px; resize: vertical; font-family: monospace; font-size: 0.9em; }
        pre { background-color: #f0f0f0; padding: 1rem; border-radius: 4px; white-space: pre-wrap; word-break: break-all; margin: 0; }
        button { width: auto; }
        summary { cursor: pointer; font-weight: bold; }

        /* Adaptive Column Layout */
        .two-column-layout { display: flex; flex-direction: row; gap: 2rem; }
        .two-column-layout > .column { flex: 1; display: flex; flex-direction: column; gap: 1rem; }
        @media (max-width: 800px) {
            .two-column-layout { flex-direction: column; gap: 1rem; }
        }

        /* Tab-based Layout Styles */
        main > section {
            display: none;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
        }
        main > section.active { display: block; }
        
        /* Chat Interface Styles */
        chat-interface { display: block; border: 1px solid var(--color-border); padding: 1rem; border-radius: 4px; }
        .chat-controls { display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; }
        .chat-controls label { margin: 0; }
        .chat-message-row { display: flex; gap: 0.5rem; align-items: flex-start; margin-bottom: 0.5rem; }
        .chat-message-row select { flex: 0 0 100px; }
        .chat-message-row textarea { flex: 1 1 auto; height: 80px; margin: 0; }
        .chat-message-row button.remove-message { flex: 0 0 auto; width: 40px; padding: 0.5rem 0; background-color: var(--color-accent-background); border-color: var(--color-accent); color: var(--color-accent); line-height: 1; }

        /* Gateway Headers & Params */
        .headers-container { display: flex; flex-direction: column; gap: 0.5rem; }
        .header-row { display: flex; gap: 0.5rem; align-items: center; }
        .header-row input { flex: 1; }
        .header-row .remove-item { flex: 0 0 auto; width: 40px; padding: 0.5rem 0; background-color: var(--color-accent-background); border-color: var(--color-accent); color: var(--color-accent); line-height: 1; }
        /* Gateway Layout */
        .side-by-side { display: flex; flex-direction: row; gap:1rem;}
        .side-by-side > figure { flex: 1; min-width: 0; margin:0}
    </style>
</head>
<body>
    <header>
        <h1>PromptMask WebUI</h1>
        <nav>
            <ul>
                <li><a href="#texts" class="active" onclick="showPage('page-texts', this)">Mask/Unmask Texts</a></li>
                <li><a href="#chat" onclick="showPage('page-chat', this)">Mask/Unmask Chat</a></li>
                <li><a href="#gateway" onclick="showPage('page-gateway', this)">Gateway</a></li>
                <li><a href="#settings" onclick="showPage('page-settings', this)">Settings</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <!-- TEXTS PAGE -->
        <section id="page-texts" class="active">
            <div class="two-column-layout">
                <div class="column">
                    <form onsubmit="event.preventDefault(); maskText(event)">
                        <label for="textInput">Original Text</label>
                        <textarea id="textInput" placeholder="e.g., My name is John Doe and my phone is 123-456-7890."></textarea>
                        <button type="submit">Mask →</button>
                    </form>
                </div>
                <div class="column">
                    <label for="maskedTextOutput">Masked Text</label>
                    <textarea id="maskedTextOutput" placeholder="Masked text will appear here..."></textarea>
                    <label for="maskMapOutput">Mask Map</label>
                    <pre><code id="maskMapOutput">{...}</code></pre>
                    <form onsubmit="event.preventDefault(); unmaskText(event)">
                        <button type="submit">← Unmask</button>
                    </form>
                    <label for="unmaskedTextOutput">Unmasked Text</label>
                    <textarea id="unmaskedTextOutput" readonly placeholder="Unmasked result..."></textarea>
                </div>
            </div>
        </section>

        <!-- CHAT PAGE -->
        <section id="page-chat">
            <div class="two-column-layout">
                <div class="column">
                    <form onsubmit="event.preventDefault(); maskMessages(event)">
                        <label>Original Messages</label>
                        <chat-interface id="chat-mask-editor" initial-messages='[{"role": "user", "content": "Hi, my name is Alice and I live at 123 Main St."}]'></chat-interface>
                        <button type="submit">Mask →</button>
                    </form>
                </div>
                <div class="column">
                    <label for="maskedMessagesOutput">Masked Messages (JSON)</label>
                    <textarea id="maskedMessagesOutput" placeholder="Masked messages will appear here..."></textarea>
                    <label for="chatMaskMapOutput">Mask Map</label>
                    <pre><code id="chatMaskMapOutput">{...}</code></pre>
                    <form onsubmit="event.preventDefault(); unmaskMessages(event)">
                        <button type="submit">← Unmask</button>
                    </form>
                    <label for="unmaskedMessagesOutput">Unmasked Messages (JSON)</label>
                    <textarea id="unmaskedMessagesOutput" readonly placeholder="Unmasked messages result..."></textarea>
                </div>
            </div>
        </section>

        <!-- GATEWAY PAGE -->
        <section id="page-gateway">
            <article>
                <h3>Gateway Status</h3>
                <p>
                    Health Check: <b id="healthStatus">UNKNOWN</b>
                    <button onclick="checkHealth()" style="width:auto;display:inline-block;padding:0.5rem;vertical-align:middle;">Check Now</button>
                </p>
                <hr>
                <h3>Gateway Live Test (Chat Completion Stream)</h3>
                <p>Upstream Target: <code id="upstreamTarget">loading...</code><br><small>This is controlled by <code>web.upstream_oai_api_base</code> in your configuration (<b>Settings</b> tab).</small></p>
                <form onsubmit="event.preventDefault(); testGatewayStream(event)">
                    <label>Request Headers</label>
                    <div id="gatewayHeadersContainer" class="headers-container">
                        <!-- Header rows will be added here by JS -->
                    </div>
                    <button type="button" onclick="headersEditor.add()">+</button>
                    <label>Request Body Parameters</label>
                    <div id="gatewayParamsContainer" class="headers-container">
                        <!-- Parameter rows will be added here by JS -->
                    </div>
                    <button type="button" onclick="paramsEditor.add()">+</button>
                    
                    <label for="gatewayChatEditor">Messages</label>
                    <chat-interface id="gatewayChatEditor" initial-messages='[{"role": "user", "content": "My name is John Doe and my phone is 123-456-7890. Can you rewrite the information in CSV format"}]'></chat-interface>
                    <button type="submit">Send Stream Request via Gateway</button>
                </form>
                <section class="side-by-side">
                    <figure>
                        <label for="gatewayStreamOriginalOutput">Live Original (Masked) Stream Output</label>
                        <pre id="gatewayStreamOriginalOutput"><code></code></pre>
                    </figure>
                    <figure>
                        <label for="gatewayStreamOutput">Live Unmasked Stream Output</label>
                        <pre id="gatewayStreamOutput"><code></code></pre>
                    </figure>
                </section>
            </article>
        </section>

        <!-- SETTINGS PAGE -->
        <section id="page-settings">
             <article>
                <h3>Configuration</h3>
                <p>View and edit <code>promptmask.config.user.toml</code>. Changes are hot-reloaded on the server.</p>
                <form onsubmit="event.preventDefault(); saveConfig(event)">
                    <label for="configEditor">Config (JSON format for editing)</label>
                    <textarea id="configEditor" style="height:400px;"></textarea>
                    <button type="submit">Save & Reload Configuration</button>
                </form>
                <p>Status: <i id="configStatus"></i></p>
             </article>
        </section>
    </main>

    <footer><hr><p>PromptMask WebUI</p></footer>

    <!-- Template for a single chat message row -->
    <template id="chat-message-row-template">
        <div class="chat-message-row">
            <select class="role">
                <option value="user">user</option>
                <option value="assistant">assistant</option>
                <option value="system">system</option>
            </select>
            <textarea class="content" placeholder="Message content..." rows="3"></textarea>
            <button type="button" class="remove-message" title="Remove message">×</button>
        </div>
    </template>

    <!-- Template for KV editor rows -->
    <template id="gateway-header-row-template">
        <div class="header-row">
            <input type="text" class="header-key" placeholder="Header Name (e.g., Authorization)">
            <input type="text" class="header-value" placeholder="Header Value (e.g., Bearer sk-...)">
            <button type="button" class="remove-item" title="Remove item">×</button>
        </div>
    </template>
    <template id="gateway-parameter-row-template">
        <div class="header-row">
            <input type="text" class="param-key" placeholder="Parameter Name (e.g., model)">
            <input type="text" class="param-value" placeholder="Value (e.g., gpt-4, or 0.7)">
            <button type="button" class="remove-item" title="Remove item">×</button>
        </div>
    </template>

<script>
// global window
var headersEditor,paramsEditor;
// --- Utils (compact style) ---
var $=id=>document.getElementById(id), $$=q=>document.querySelectorAll(q);
var post=(url,d)=>fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).then(r=>{if(!r.ok)return r.json().then(e=>Promise.reject(new Error(e.detail||`HTTP ${r.status}`)));return r.json()});
var get=url=>fetch(url).then(r=>{if(!r.ok)return r.json().then(e=>Promise.reject(new Error(e.detail||`HTTP ${r.status}`)));return r.json()});
var notify=(el,msg,isError)=>{el.textContent=msg;el.style.color=isError?'red':'green';};
var manageButtonLoading=btn=>{if(!btn)return()=>{};var o=btn.textContent,s=Date.now();btn.disabled=!0;var i=setInterval(()=>{var e=(Date.now()-s)/1000;btn.textContent=`⌛️ waited for ${e.toFixed(1)} sec`},100);return()=>{clearInterval(i);btn.textContent=o;btn.disabled=!1}};
async function handleApi(btn,action,resultHandler,errorHandler){var done=manageButtonLoading(btn);try{var r=await action();resultHandler(r);}catch(e){errorHandler(e);console.error(e);}finally{done();}}

function createKeyValueEditor(c){
  var el=$(c.containerId);
  el.addEventListener('click',e=>{
    if(e.target.classList.contains(c.removeClass))e.target.closest('.header-row').remove();
  });
  function add(k,v){
    var t=$(c.templateId).content.cloneNode(true);
    t.querySelector('.'+c.keyClass).value=k||'';
    t.querySelector('.'+c.valueClass).value=v||'';
    el.appendChild(t);
  }
  function get(){
    var d={};
    el.querySelectorAll('.header-row').forEach(r=>{
      var k=r.querySelector('.'+c.keyClass).value.trim(),
          v=r.querySelector('.'+c.valueClass).value.trim();
      if(k)d[k]=c.valueParser?c.valueParser(v):v
    });
    return d;
  }
  return {add,get}
}

// --- Chat Interface Web Component (Light DOM for classless css compatibility) ---
customElements.define('chat-interface', class extends HTMLElement {
    connectedCallback() {
        var self = this; // 'this' context for event handlers
        this.innerHTML = `
            <div class="chat-controls">
                <button type="button" class="add-message">Add Message</button>
                <label>
                    <input type="checkbox" class="toggle-system"> Optional First 'system' Message
                </label>
            </div>
            <div class="messages-container"></div>
        `;
        this.messagesContainer = this.querySelector('.messages-container');
        this.systemToggle = this.querySelector('.toggle-system');
        
        // Event Listeners
        this.querySelector('.add-message').addEventListener('click', function() { self.addMessage(); });
        this.systemToggle.addEventListener('change', function() { self.updateSystemMessage(); });
        this.messagesContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-message')) {
                e.target.closest('.chat-message-row').remove();
                self.updateSystemMessageState();
            }
        });
        
        // Initial state
        var initialMessages = this.getAttribute('initial-messages');
        if (initialMessages) {
            try {
                JSON.parse(initialMessages).forEach(function(msg) {
                    self.addMessage(msg.role, msg.content);
                });
            } catch(e) { console.error("Invalid initial-messages JSON:", e); this.addMessage('user'); }
        } else {
            this.addMessage('user');
        }
        this.updateSystemMessageState();
    }

    addMessage(role, content) {
        var template = $('chat-message-row-template').content.cloneNode(true);
        var row = template.querySelector('.chat-message-row');
        var select = row.querySelector('.role');
        var textarea = row.querySelector('.content');

        if (role) {
            select.value = role;
        } else {
            var lastRow = this.messagesContainer.querySelector('.chat-message-row:last-of-type');
            select.value = (lastRow && lastRow.querySelector('.role').value === 'user') ? 'assistant' : 'user';
        }
        textarea.value = content || '';
        
        // A system message can only be at the top. Hide the role selector if not.
        select.querySelector('option[value="system"]').hidden = this.messagesContainer.children.length > 0;
        
        this.messagesContainer.appendChild(row);
    }

    updateSystemMessage() {
        var firstRow = this.messagesContainer.querySelector('.chat-message-row:first-of-type');
        var hasSystem = firstRow && firstRow.querySelector('.role').value === 'system';

        if (this.systemToggle.checked && !hasSystem) {
            var template = $('chat-message-row-template').content.cloneNode(true);
            template.querySelector('.role').value = 'system';
            template.querySelector('.role option[value="user"]').remove();
            template.querySelector('.role option[value="assistant"]').remove();
            this.messagesContainer.prepend(template.querySelector('.chat-message-row'));
        } else if (!this.systemToggle.checked && hasSystem) {
            firstRow.remove();
        }
    }
    
    updateSystemMessageState() {
        var firstRow = this.messagesContainer.querySelector('.chat-message-row:first-of-type');
        this.systemToggle.checked = firstRow && firstRow.querySelector('.role').value === 'system';
    }
    
    getMessages() {
        var messages = [];
        this.querySelectorAll('.chat-message-row').forEach(function(row) {
            messages.push({
                role: row.querySelector('.role').value,
                content: row.querySelector('.content').value
            });
        });
        return messages;
    }
});


// --- Navigation ---
function showPage(pageId, navEl) {
    $$('main > section').forEach(s => s.classList.remove('active'));
    $(pageId).classList.add('active');
    $$('nav a').forEach(a => a.classList.remove('active'));
    if (navEl) navEl.classList.add('active');
    if (pageId === 'page-settings') loadConfig();
    if (pageId === 'page-gateway') updateGatewayInfo();
}


// --- API Handlers ---
function maskText(event) {
    var text = $('textInput').value;
    handleApi(
        event.submitter,
        () => post('/v1/mask', { text }),
        (data) => {
            $('maskedTextOutput').value = data.masked_text;
            $('maskMapOutput').textContent = JSON.stringify(data.mask_map, null, 2);
            $('unmaskedTextOutput').value = ''; // Clear previous result
        },
        (err) => alert(`Masking failed: ${err.message}`)
    );
}

function unmaskText(event) {
    try {
        var masked_text = $('maskedTextOutput').value;
        var mask_map = JSON.parse($('maskMapOutput').textContent);
        handleApi(
            event.submitter,
            () => post('/v1/unmask', { masked_text, mask_map }),
            (data) => {
                $('unmaskedTextOutput').value = data.text;
            },
            (err) => alert(`Unmasking failed: ${err.message}`)
        );
    } catch (e) {
        alert(`Invalid Mask Map JSON: ${e.message}`);
    }
}

function maskMessages(event) {
    try {
        var messages = $('chat-mask-editor').getMessages();
        handleApi(
            event.submitter,
            () => post('/v1/mask_messages', { messages }),
            (data) => {
                $('maskedMessagesOutput').value = JSON.stringify(data.masked_messages, null, 2);
                $('chatMaskMapOutput').textContent = JSON.stringify(data.mask_map, null, 2);
                $('unmaskedMessagesOutput').value = ''; // Clear
            },
            (err) => alert(`Masking messages failed: ${err.message}`)
        );
    } catch (e) {
        alert(`Could not process messages: ${e.message}`);
    }
}

function unmaskMessages(event) {
    try {
        var masked_messages = JSON.parse($('maskedMessagesOutput').value);
        var mask_map = JSON.parse($('chatMaskMapOutput').textContent);
        handleApi(
            event.submitter,
            () => post('/v1/unmask_messages', { masked_messages, mask_map }),
            (data) => {
                $('unmaskedMessagesOutput').value = JSON.stringify(data.messages, null, 2);
            },
            (err) => alert(`Unmasking messages failed: ${err.message}`)
        );
    } catch (e) {
        alert(`Invalid JSON: ${e.message}`);
    }
}


// --- Gateway ---
function checkHealth() {
    var statusElement = $('healthStatus');
    statusElement.textContent = 'Checking...';
    handleApi(
        () => get('/v1/health'),
        (data) => {
            statusElement.textContent = data.status.toUpperCase();
            statusElement.style.color = 'green';
        },
        () => {
            statusElement.textContent = 'OFFLINE';
            statusElement.style.color = 'red';
        }
    );
}

function updateGatewayInfo() {
    var targetEl = $('upstreamTarget');
    if (!targetEl) return;
    targetEl.textContent = 'loading...';
    get('/v1/config').then(function(data) {
        targetEl.textContent = data?.web?.upstream_oai_api_base || 'Not Set';
    }).catch(function(err) {
        targetEl.textContent = 'Error loading config.';
        console.error('Failed to load upstream target info:', err);
    });
}

async function testGatewayStream(event) {
    var reEnableButton = manageButtonLoading(event.submitter);
    var unmaskedOutputElement = $('gatewayStreamOutput').querySelector('code');
    var originalOutputElement = $('gatewayStreamOriginalOutput').querySelector('code'); // New element
    unmaskedOutputElement.textContent = 'Connecting to stream...';
    originalOutputElement.textContent = 'Connecting to stream...';
    
    try {
        var messages = $('gatewayChatEditor').getMessages();
        var customHeaders = headersEditor.get();
        var headers = { 'Content-Type': 'application/json', 'Accept': 'text/event-stream' };
        Object.assign(headers, customHeaders);

        var customParams = paramsEditor.get();
        var payload = Object.assign({ messages: messages, stream: true }, customParams)
        var response = await fetch('/gateway/v1/chat/completions',{method:'POST',headers,body:JSON.stringify(payload)});

        if (!response.ok) throw new Error(`Gateway returned ${response.status} ${response.statusText}`);
        
        unmaskedOutputElement.textContent = ''; // Clear and prepare for stream
        originalOutputElement.textContent = ''; // Clear and prepare for stream
        var reader = response.body.getReader();
        var decoder = new TextDecoder();

        while (true) {
            var { value, done } = await reader.read();
            if (done) {
                reEnableButton();
                break;
            }
            
            var chunk = decoder.decode(value, { stream: true });
            var lines = chunk.split('\n').filter(line => line.trim() !== '');

            for (var line of lines) {
                if (!line.startsWith('data: ')) continue;
                var jsonStr = line.substring(6);
                if (jsonStr === '[DONE]') continue;
                try {
                    var data = JSON.parse(jsonStr);
                    var unmaskedContent = data.choices?.[0]?.delta?.content || '';
                    var originalContent = data.choices?.[0]?.delta?.original_content;

                    // If original_content exists, use it. Otherwise, it's not a content chunk we care about.
                    if (originalContent !== undefined) originalOutputElement.textContent += originalContent;
                    unmaskedOutputElement.textContent += unmaskedContent;

                } catch (e) { /* Ignore incomplete JSON chunks */ }
            }
        }
    } catch (e) {
        unmaskedOutputElement.textContent = `Error: ${e.message}`;
        originalOutputElement.textContent = `Error: ${e.message}`;
        console.error(e);
        reEnableButton();
    }
}


// --- Settings ---
function loadConfig() {
    var statusEl = $('configStatus');
    notify(statusEl, 'Loading...');
    handleApi(
        () => get('/v1/config'),
        (data) => {
            $('configEditor').value = JSON.stringify(data, null, 2);
            notify(statusEl, 'Config loaded successfully.');
        },
        (error) => notify(statusEl, `Failed to load config: ${error.message}`, true)
    );
}

function saveConfig(event) {
    var statusEl = $('configStatus');
    try {
        var config = JSON.parse($('configEditor').value);
        notify(statusEl, 'Saving and reloading...');
        handleApi(
            event.submitter,
            () => post('/v1/config', config),
            (data) => {
                notify(statusEl, data.message || 'Config saved and reloaded!');
                updateGatewayInfo(); // Update the gateway page info as it might have changed
            },
            (error) => notify(statusEl, `Failed to save config: ${error.message}`, true)
        );
    } catch (e) {
        notify(statusEl, `Invalid JSON format: ${e.message}`, true);
    }
}


// --- Init ---
window.onload = () => {
    headersEditor = createKeyValueEditor({
        containerId: 'gatewayHeadersContainer',
        templateId: 'gateway-header-row-template',
        keyClass: 'header-key',
        valueClass: 'header-value',
        removeClass: 'remove-item'
    });
    headersEditor.add('Authorization', 'Bearer ');
    paramsEditor = createKeyValueEditor({
        containerId: 'gatewayParamsContainer',
        templateId: 'gateway-parameter-row-template',
        keyClass: 'param-key',
        valueClass: 'param-value',
        removeClass: 'remove-item',
        valueParser: function(value) { // Special parser for params
            try { return JSON.parse(value); } 
            catch (e) { return value; } // Return as string if not valid JSON
        }
    });
    paramsEditor.add('model', 'gpt-100');
    paramsEditor.add('temperature', '0.7');

    // Set initial page from hash or default to first tab
    var hash = window.location.hash || '#texts';
    var navLink = document.querySelector('nav a[href="' + hash + '"]');
    var pageId = 'page-' + hash.substring(1);
    showPage(pageId, navLink);
    checkHealth();
    setInterval(checkHealth, 30000); // Check health every 30s
};
</script>

</body>
</html>