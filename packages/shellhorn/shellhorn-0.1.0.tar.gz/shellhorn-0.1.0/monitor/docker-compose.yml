version: '3.8'

services:
  conch-monitor:
    build: .
    container_name: conch-monitor
    restart: unless-stopped
    
    # Environment variables (override in .env file)
    environment:
      - MQTT_BROKER=${MQTT_BROKER:-localhost}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - MQTT_TOPIC_PREFIX=${MQTT_TOPIC_PREFIX:-conch}
      - CONCH_TIMEOUT_MINUTES=${CONCH_TIMEOUT_MINUTES:-30}
      - CONCH_CHECK_INTERVAL=${CONCH_CHECK_INTERVAL:-60}
      - CONCH_STATUS_INTERVAL=${CONCH_STATUS_INTERVAL:-300}
    
    # Mount secrets file (recommended approach)
    volumes:
      - ./config:/etc/conch-monitor:ro
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s = socket.socket(); s.settimeout(5); result = s.connect_ex(('${MQTT_BROKER:-localhost}', int('${MQTT_PORT:-1883}'))); s.close(); exit(result)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    
    # Security settings
    user: "1001:1001"
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=10m
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'
        reservations:
          memory: 16M
          cpus: '0.05'
    
    # Network
    networks:
      - conch-network

networks:
  conch-network:
    driver: bridge