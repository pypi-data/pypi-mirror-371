<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="it" xml:lang="it"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Perché è stato creato Tométo Tomato – Tometo Tomato</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-cca5a5424a93048cc934d55e7e879e63.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Nessun risultato",
    "search-matching-documents-text": "documenti trovati",
    "search-copy-link-title": "Copiare il link nella ricerca",
    "search-hide-matches-text": "Nascondere i risultati aggiuntivi",
    "search-more-match-text": "ci sono altri risultati in questo documento",
    "search-more-matches-text": "ulteriori risultati in questo documento",
    "search-clear-button-title": "Pulire",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancellare",
    "search-submit-button-title": "Inviare",
    "search-label": "Ricerca"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Tometo Tomato</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Ricerca"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Attiva/disattiva la navigazione" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../doc_sources/about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">In questa pagina</h2>
   
  <ul>
  <li><a href="#introduzione" id="toc-introduzione" class="nav-link active" data-scroll-target="#introduzione">Introduzione</a>
  <ul class="collapse">
  <li><a href="#file-di-esempio" id="toc-file-di-esempio" class="nav-link" data-scroll-target="#file-di-esempio">File di esempio</a></li>
  </ul></li>
  <li><a href="#utilizzare-sql" id="toc-utilizzare-sql" class="nav-link" data-scroll-target="#utilizzare-sql">Utilizzare SQL</a>
  <ul class="collapse">
  <li><a href="#fare-il-join" id="toc-fare-il-join" class="nav-link" data-scroll-target="#fare-il-join">Fare il JOIN</a></li>
  <li><a href="#fare-il-join-fuzzy" id="toc-fare-il-join-fuzzy" class="nav-link" data-scroll-target="#fare-il-join-fuzzy">Fare il JOIN “fuzzy”</a></li>
  <li><a href="#una-sintesi-per-ridurre-le-distanze" id="toc-una-sintesi-per-ridurre-le-distanze" class="nav-link" data-scroll-target="#una-sintesi-per-ridurre-le-distanze">Una sintesi per ridurre le distanze</a></li>
  </ul></li>
  <li><a href="#note-finali" id="toc-note-finali" class="nav-link" data-scroll-target="#note-finali">Note finali</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Perché è stato creato Tométo Tomato</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduzione" class="level2">
<h2 class="anchored" data-anchor-id="introduzione">Introduzione</h2>
<p>Chiunque lavori con i dati molto spesso si imbatte in colonne che dovrebbero rispettare una codifica, un valore standard, una lista di valori noti, ma presentano invece <strong>errori di battitura</strong>, <strong>spazi in eccesso</strong>, <strong>caratteri speciali al posto di caratteri accentati</strong>, <strong>maiuscole/minuscole non coerenti</strong>, ecc..</p>
<p>Qui sotto ad esempio dei nomi ci città italiane, riportati in modo errato:</p>
<table class="table-striped small table-sm caption-top table">
<caption>Esempi di nomi di città errati</caption>
<colgroup>
<col style="width: 30%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th>city</th>
<th>tipo di errore</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cefalu’</td>
<td>bisognerebbe usare la <code>ù</code> e non <code>u'</code></td>
</tr>
<tr class="even">
<td>Reggio Calabria</td>
<td>Il nome corretto è <code>Reggio di Calabria</code></td>
</tr>
<tr class="odd">
<td>RODENGO-SAIANO</td>
<td>bisognerebbe usare <code>Rodengo Saiano</code>, senza <code>-</code> e non tutto maiuscolo</td>
</tr>
</tbody>
</table>
<p><br> Se volessi associare a queste città il codice<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> che <strong>Istat</strong> - l’istituto nazionale di statistica - assegna a ciascuna città, non potrei farlo con una semplice operazione di join, perché i nomi non corrispondono esattamente. Associare un codice a ciascun comune è operazione molto importante perché mi consente di <strong>unire</strong> dati provenienti da fonti diverse, che altrimenti non potrei confrontare, ma anche di <strong>generare</strong> ad esempio <strong>automaticamente</strong> <strong>mappe</strong>, perché i software spesso usano proprio questi codici per identificare i comuni.</p>
<div class="callout callout-style-simple callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pay Attention
</div>
</div>
<div class="callout-body-container callout-body">
<p>Chi fa didattica sui dati di solito infatti dice (urlando): <strong>CODES, NOT LABELS!!</strong></p>
</div>
</div>
<p>I codici correlati alle unità amministrative italiane sono pubblici e liberamente accessibili in CC-BY-4.0 su diverse sezioni del sito Istat. Uno di questi è il <a href="https://situas.istat.it">SITUAS</a>, in cui c’è la pagina con l’“<a href="https://situas.istat.it/web/#/territorio/body?id=61&amp;dateFrom=2025-08-23"><strong>Elenco dei codici e delle denominazioni delle unità territoriali</strong></a>”, scaricabili in formato <code>CSV</code> e <code>JSON</code>.</p>
<table class="table-striped small table-sm caption-top table">
<caption>Esempio di dati ufficiali Istat sui comuni italiani</caption>
<thead>
<tr class="header">
<th>city</th>
<th>region</th>
<th>istat_city_code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cefalù</td>
<td>Sicilia</td>
<td>082027</td>
</tr>
<tr class="even">
<td>Reggio di Calabria</td>
<td>Calabria</td>
<td>080063</td>
</tr>
<tr class="odd">
<td>Rodengo Saiano</td>
<td>Lombardia</td>
<td>017163</td>
</tr>
</tbody>
</table>
<p><br> Se provassi a fare un join tra i dati errati e questi dati ufficiali, <strong>non otterrei alcun risultato</strong>.</p>
<hr>
<p>👉 Tométo Tomato è stato creato per risolvere questo problema: consente di <strong>fare comodamente</strong> join <strong>non basati su corrispondenze esatte</strong>, ma su <strong>corrispondenze “simili”</strong>, e <strong>arricchire</strong>, <strong>modificare</strong>, <strong>correggere</strong> la propria brutta tabella di input, confrontandola con una tabella di riferimento.</p>
<hr>
<section id="file-di-esempio" class="level3">
<h3 class="anchored" data-anchor-id="file-di-esempio">File di esempio</h3>
<p>Queste sono le nostre due tabelle di esempio, disponibili come <a href="files/input.csv"><code>input.csv</code></a> e <a href="files/ref_sample.csv"><code>ref_sample.csv</code></a> in modo che sia possibile scaricarle e provare a eseguire gli esempi.</p>
</section>
</section>
<section id="utilizzare-sql" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="utilizzare-sql">Utilizzare SQL</h2>
<section id="fare-il-join" class="level3">
<h3 class="anchored" data-anchor-id="fare-il-join">Fare il JOIN</h3>
<p>Il primo test è quello di lanciare una semplice query SQL di join, per vedere cosa succede a partire dai nostri dati di esempio.</p>
<div class="columns">
<div class="column" style="width:46%;">
<table class="table-striped small table-sm caption-top table">
<caption>The raw data</caption>
<thead>
<tr class="header">
<th>city</th>
<th>region</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cefalu’</td>
<td>Sicilia</td>
</tr>
<tr class="even">
<td>Reggio Calabria</td>
<td>CALABRIA</td>
</tr>
<tr class="odd">
<td>RODENGO-SAIANO</td>
<td>Lombardia</td>
</tr>
</tbody>
</table>
</div><div class="column" style="width:8%;">

</div><div class="column" style="width:46%;">
<table class="table-striped small table-sm caption-top table">
<caption>The reference data</caption>
<thead>
<tr class="header">
<th>city</th>
<th>region</th>
<th>city_code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cefalù</td>
<td>Sicilia</td>
<td>082027</td>
</tr>
<tr class="even">
<td>Reggio di Calabria</td>
<td>Calabria</td>
<td>080063</td>
</tr>
<tr class="odd">
<td>Rodengo Saiano</td>
<td>Lombardia</td>
<td>017164</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><br> La query può essere quella di sotto. È impostata come un <code>LEFT JOIN</code>, in modo da mostrare tutte le righe della tabella di sinistra, anche se non trovano corrispondenza nella tabella di destra.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  i.<span class="op">*</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  r.city_code</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> read_csv_auto(<span class="st">'input.csv'</span>) <span class="kw">AS</span> i</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> read_csv_auto(<span class="st">'ref_sample.csv'</span>) <span class="kw">AS</span> r</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> i.city <span class="op">=</span> r.city <span class="kw">AND</span> i.region <span class="op">=</span> r.region</span></code><button title="Copia negli appunti" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Nota
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Nota</strong>: l’uso di <code>read_csv_auto</code> nella query di sopra è una funzionalità di <a href="https://duckdb.org/"><strong>DuckDB</strong></a> che consente di leggere direttamente file CSV senza doverli importare prima in una tabella. In questo modo è possibile fare esperimenti veloci senza dover creare tabelle temporanee.</p>
</div>
</div>
<p>In output otteniamo un pessimo risultato: nessuna delle righe della tabella di sinistra trova corrispondenza nella tabella di destra, e quindi il campo <code>city_code</code> risulta sempre <code>NULL</code>.</p>
<table class="table-striped small table-sm caption-top table">
<caption>Risultato di un join tra dati errati e dati ufficiali</caption>
<thead>
<tr class="header">
<th>city</th>
<th>region</th>
<th>istat_city_code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cefalu’</td>
<td>Sicilia</td>
<td>NULL</td>
</tr>
<tr class="even">
<td>Reggio Calabria</td>
<td>CALABRIA</td>
<td>NULL</td>
</tr>
<tr class="odd">
<td>RODENGO-SAIANO</td>
<td>Lombardia</td>
<td>NULL</td>
</tr>
</tbody>
</table>
</section>
<section id="fare-il-join-fuzzy" class="level3">
<h3 class="anchored" data-anchor-id="fare-il-join-fuzzy">Fare il JOIN “fuzzy”</h3>
<p>Un JOIN “fuzzy”, sfumato, è quello che consente di trovare corrispondenze anche quando i valori non sono esattamente uguali, ma “simili”. Ad esempio, potremmo voler considerare come corrispondenti i nomi di città che differiscono per un solo carattere, o che hanno una distanza di Levenshtein (numero di operazioni necessarie per trasformare una stringa in un’altra) inferiore a una certa soglia.</p>
<p>Potremmo riscrivere la query di join precedente in questo modo, usando la <a href="https://duckdb.org/docs/stable/sql/functions/text#levenshteins1-s2">funzione <code>levenshtein</code> di DuckDB</a> per il campo <code>city</code> in modo da considererare come corrispondenti i nomi di città che differiscono per al massimo 2 caratteri:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  i.city <span class="kw">AS</span> input_city,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  i.region <span class="kw">AS</span> input_region,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  r.city <span class="kw">AS</span> ref_city,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  r.region <span class="kw">AS</span> ref_region,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  r.city_code,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  levenshtein(i.city, r.city) <span class="kw">AS</span> levenshtein_distance</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> read_csv_auto(<span class="st">'input.csv'</span>) <span class="kw">AS</span> i</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> read_csv_auto(<span class="st">'ref_sample.csv'</span>) <span class="kw">AS</span> r</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> i.region <span class="op">=</span> r.region</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> levenshtein(i.city, r.city) <span class="op">&lt;=</span> <span class="dv">2</span>;</span></code><button title="Copia negli appunti" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table-striped small table-sm caption-top table">
<caption>Risultato di un join fuzzy tra dati errati e dati ufficiali</caption>
<colgroup>
<col style="width: 18%">
<col style="width: 13%">
<col style="width: 18%">
<col style="width: 12%">
<col style="width: 11%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>input_city</th>
<th>input_region</th>
<th>ref_city</th>
<th>ref_region</th>
<th>city_code</th>
<th style="text-align: right;">levenshtein_distance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cefalu’</td>
<td>Sicilia</td>
<td>Cefalù</td>
<td>Sicilia</td>
<td>082027</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
<p>L’unica città di cui c’è un risulato è soltanto <code>Cefalu'</code>, perché la <strong>distanza</strong> di Levenshtein tra <code>Cefalu'</code> e <code>Cefalù</code> è <strong>2</strong>: sostituzione di <code>u'</code> con <code>ù</code> e rimozione di <code>'</code>.</p>
<p>Se aumentiamo la soglia a 10, non cambia nulla, perché ad esempio il Comune di <code>Rodengo Saiano</code> è scritto in maiuscolo e con il trattino e la distanza tra <code>RODENGO-SAIANO</code> e <code>Rodengo Saiano</code> è pari a <strong>12</strong>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">SELECT</span> levenshtein<span class="er">(</span><span class="st">'RODENGO-SAIANO'</span><span class="ex">,</span> <span class="st">'Rodengo Saiano'</span><span class="kw">)</span> <span class="ex">AS</span> distance<span class="kw">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">12</span></span></code><button title="Copia negli appunti" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Se si imposta la soglia a 15 ne otteniamo in ogni caso soltanto 2, perché il JOIN del campo <code>region</code> non trova corrispondenza tra <code>CALABRIA</code> e <code>Calabria</code>. Quindi dovremmo usare una funzione di distanza tra stringhe anche per il campo <code>region</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  i.city <span class="kw">AS</span> input_city,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  i.region <span class="kw">AS</span> input_region,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  r.city <span class="kw">AS</span> ref_city,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  r.region <span class="kw">AS</span> ref_region,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  r.city_code,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  levenshtein(i.city, r.city) <span class="kw">AS</span> levenshtein_distance</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> read_csv_auto(<span class="st">'input.csv'</span>) <span class="kw">AS</span> i</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> read_csv_auto(<span class="st">'ref_sample.csv'</span>) <span class="kw">AS</span> r</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> levenshtein(i.city, r.city) <span class="op">&lt;=</span> <span class="dv">15</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> levenshtein(<span class="fu">LOWER</span>(i.region), <span class="fu">LOWER</span>(r.region)) <span class="op">&lt;</span> <span class="dv">10</span></span></code><button title="Copia negli appunti" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ma è l’<strong>output non è</strong> proprio <strong>quello che ci aspettiamo</strong>, non 3 righe in totale (una per ogni Comune), ma <strong>ben 8 righe</strong>:</p>
<table class="table-striped small table-sm caption-top table">
<caption>Risultato di un join fuzzy tra dati errati e dati ufficiali</caption>
<colgroup>
<col style="width: 17%">
<col style="width: 13%">
<col style="width: 21%">
<col style="width: 12%">
<col style="width: 11%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th>input_city</th>
<th>input_region</th>
<th>ref_city</th>
<th>ref_region</th>
<th>city_code</th>
<th style="text-align: right;">levenshtein_distance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cefalu’</td>
<td>Sicilia</td>
<td>Cefalù</td>
<td>Sicilia</td>
<td>082027</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td>Cefalu’</td>
<td>Sicilia</td>
<td>Reggio di Calabria</td>
<td>Calabria</td>
<td>080063</td>
<td style="text-align: right;">15</td>
</tr>
<tr class="odd">
<td>Cefalu’</td>
<td>Sicilia</td>
<td>Rodengo Saiano</td>
<td>Lombardia</td>
<td>017163</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td>Reggio Calabria</td>
<td>CALABRIA</td>
<td>Cefalù</td>
<td>Sicilia</td>
<td>082027</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td>Reggio Calabria</td>
<td>CALABRIA</td>
<td>Reggio di Calabria</td>
<td>Calabria</td>
<td>080063</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td>Reggio Calabria</td>
<td>CALABRIA</td>
<td>Rodengo Saiano</td>
<td>Lombardia</td>
<td>017163</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="odd">
<td>RODENGO-SAIANO</td>
<td>Lombardia</td>
<td>Cefalù</td>
<td>Sicilia</td>
<td>082027</td>
<td style="text-align: right;">14</td>
</tr>
<tr class="even">
<td>RODENGO-SAIANO</td>
<td>Lombardia</td>
<td>Rodengo Saiano</td>
<td>Lombardia</td>
<td>017163</td>
<td style="text-align: right;">12</td>
</tr>
</tbody>
</table>
<p>Quando si esegue un JOIN esatto, l’obiettivo è trovare una singola e chiara corrispondenza per ogni riga. Nel mondo del “fuzzy matching”, le regole cambiano. Abbassando le nostre pretese con soglie di distanza permissive, non stiamo più chiedendo al database “trova l’unica corrispondenza giusta”, ma piuttosto:</p>
<blockquote class="blockquote">
<p>Per ogni riga del mio input, trovami tutte le righe nel file di riferimento che soddisfano questi criteri di somiglianza generici.</p>
</blockquote>
<p>Se una riga di input è “vagamente simile” a più righe di riferimento, il database creerà una riga di output per ciascuna di queste coincidenze. Questo effetto di moltiplicazione è noto come <strong>prodotto cartesiano</strong> delle coincidenze.</p>
<p>Dopo aver generato le possibili corrispondenze, dovremmo filtrarle per tenere solo la migliore per ogni record di partenza. Il processo può essere suddiviso in tre fasi:</p>
<ul>
<li>trovare tutte le possibili corrispondenze e calcolare le distanze</li>
<li>assegnare un rango a ciascuna corrispondenza in base alla somma delle distanze</li>
<li>selezionare solo la corrispondenza con il rango più alto (cioè la più simile)</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Fase 1: trova tutti i candidati e calcola le distanze</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> all_matches <span class="kw">AS</span> (</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        i.city <span class="kw">AS</span> input_city,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        i.region <span class="kw">AS</span> input_region,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        r.city <span class="kw">AS</span> ref_city,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        r.region <span class="kw">AS</span> ref_region,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        r.city_code,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        levenshtein(i.city, r.city) <span class="kw">AS</span> city_distance,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        levenshtein(i.region, r.region) <span class="kw">AS</span> region_distance</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> read_csv_auto(<span class="st">'input.csv'</span>) <span class="kw">AS</span> i</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">JOIN</span> read_csv_auto(<span class="st">'ref_sample.csv'</span>) <span class="kw">AS</span> r</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">ON</span> levenshtein(i.city, r.city) <span class="op">&lt;=</span> <span class="dv">15</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>     <span class="kw">AND</span> levenshtein(i.region, r.region) <span class="op">&lt;</span> <span class="dv">10</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- Fase 2: assegna un rango ai candidati</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>ranked_matches <span class="kw">AS</span> (</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">PARTITION</span> <span class="kw">BY</span> input_city, input_region</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">ORDER</span> <span class="kw">BY</span> (city_distance <span class="op">+</span> region_distance) <span class="kw">ASC</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        ) <span class="kw">AS</span> rn</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> all_matches</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co">-- Fase 3: prendi solo il miglior candidato (rn = 1)</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    input_city,</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    input_region,</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    ref_city,</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    ref_region,</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    city_code,</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    city_distance,</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    region_distance</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> ranked_matches</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> rn <span class="op">=</span> <span class="dv">1</span>;</span></code><button title="Copia negli appunti" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table-striped small table-sm caption-top table">
<caption>Risultato di un join fuzzy, con selezione della migliore corrispondenza</caption>
<colgroup>
<col style="width: 15%">
<col style="width: 12%">
<col style="width: 19%">
<col style="width: 11%">
<col style="width: 10%">
<col style="width: 14%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th>input_city</th>
<th>input_region</th>
<th>ref_city</th>
<th>ref_region</th>
<th>city_code</th>
<th style="text-align: right;">city_distance</th>
<th style="text-align: right;">region_distance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cefalu’</td>
<td>Sicilia</td>
<td>Cefalù</td>
<td>Sicilia</td>
<td>082027</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td>RODENGO-SAIANO</td>
<td>Lombardia</td>
<td>Rodengo Saiano</td>
<td>Lombardia</td>
<td>017163</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td>Reggio Calabria</td>
<td>CALABRIA</td>
<td>Reggio di Calabria</td>
<td>Calabria</td>
<td>080063</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">7</td>
</tr>
</tbody>
</table>
</section>
<section id="una-sintesi-per-ridurre-le-distanze" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="una-sintesi-per-ridurre-le-distanze">Una sintesi per ridurre le distanze</h3>
<p>A seguira una tabellina di riepilogo, sull’esempio del nome del <a href="https://www.wikiwand.com/en/articles/Forza_d'Agr%C3%B2">Comune di <code>Forza·d'Agrò</code></a>, scritto però in modo errato <code>Forza··D’Agro·</code>:</p>
<ul>
<li>c’è la <code>D</code> maiuscola invece che minuscola;</li>
<li>ci sono due spazi in eccesso (uno tra <code>Forza</code> e <code>D'Agro</code> e uno alla fine);</li>
<li>non c’è la <code>o</code> accentata, ma una <code>o</code> normale;</li>
<li>c’è un apostrofo tipografico <code>’</code>, invece di uno dritto <code>'</code>.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Nota
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Nota</strong>: qui sopra sono stati resi visibili gli spazi in eccesso con il carattere <code>·</code>.</p>
</div>
</div>
<div class="column-body-outset">
<div class="table-responsive">
<table class="table-striped table-sm table-bordered small caption-top table">
<caption>Riduzione della distanza con passaggi successivi di normalizzazione</caption>
<colgroup>
<col style="width: 20%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 10%">
<col style="width: 35%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">descrizione</th>
<th style="text-align: left;">left</th>
<th style="text-align: left;">right</th>
<th style="text-align: right;">distanza</th>
<th style="text-align: left;">funzione aggiunta</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Inizio</td>
<td style="text-align: left;"><code>Forza··D’Agro·</code></td>
<td style="text-align: left;"><code>Forza·d'Agrò</code></td>
<td style="text-align: right;">7</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">In minuscolo</td>
<td style="text-align: left;"><code>forza··d’agro·</code></td>
<td style="text-align: left;"><code>forza·d'agrò</code></td>
<td style="text-align: right;">6</td>
<td style="text-align: left;"><code>LOWER('value')</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Rimossi spazi ridondanti</td>
<td style="text-align: left;"><code>forza·d’agro</code></td>
<td style="text-align: left;"><code>forza·d'agrò</code></td>
<td style="text-align: right;">5</td>
<td style="text-align: left;"><code>regexp_replace(trim(LOWER('value')), '\s+', ' ')</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Rimossi accentati</td>
<td style="text-align: left;"><code>forza·d’agro</code></td>
<td style="text-align: left;"><code>forza·d'agro</code></td>
<td style="text-align: right;">3</td>
<td style="text-align: left;"><code>strip_accents(regexp_replace(trim(LOWER('value')), '\s+', ' '))</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Rimossi caratteri speciali</td>
<td style="text-align: left;"><code>forza·dagro</code></td>
<td style="text-align: left;"><code>forza·dagro</code></td>
<td style="text-align: right;">0</td>
<td style="text-align: left;"><code>regexp_replace(strip_accents(regexp_replace(trim(LOWER('value')), '\s+', ' ')), '[^a-zA-Z0-9 ]', '', 'g')</code></td>
</tr>
</tbody>
</table>
</div>
</div>
<p><br> 👉 Quindi <strong>un caso molto brutto</strong>, pieno di errori, può essere normalizzato in modo da <strong>ridurre</strong> la <strong>distanza</strong> di Levenshtein a <strong>zero</strong>, e quindi trovare la corrispondenza esatta e <code>Forza··D'Agro·</code> è uguale a <code>Forza·d'Agrò</code> e quindi riesco a ricavarne il codice identificativo.</p>
</section>
</section>
<section id="note-finali" class="level2">
<h2 class="anchored" data-anchor-id="note-finali">Note finali</h2>
<p>In questo percorso abbiamo descritto alcuni elementi di base per misurare la “distanza” tra le stringhe e a normalizzare il testo per rendere il confronto più efficace. Abbiamo visto come gestire maiuscole/minuscole, spazi superflui, accenti e caratteri speciali, che sono gli elementi di base di ogni processo di pulizia dei dati.</p>
<p>Tuttavia, questo è solo l’inizio. Il mondo del “fuzzy matching” è molto più vasto e complesso. Per affrontare dataset più grandi e “disordinati”, si ricorre spesso a metodi più sofisticati, che vanno oltre il semplice conteggio delle modifiche:</p>
<ul>
<li>Algoritmi fonetici: Invece di guardare come sono scritte le parole, questi algoritmi le codificano in base a come suonano. Metodi come Metaphone o Soundex sono bravissimi a capire che “Smith” e “Smythe” sono probabilmente la stessa cosa.</li>
<li>Modelli statistici (n-gram): Questi metodi scompongono le stringhe in piccole parti (es. coppie o triplette di caratteri) e ne confrontano la frequenza, risultando molto efficaci nel trovare somiglianze anche quando l’ordine delle parole è diverso.</li>
</ul>
<p>Strumenti di pulizia dati come <a href="https://openrefine.org/">OpenRefine</a> integrano decine di questi algoritmi avanzati, permettendo di raggruppare e correggere dati simili con grande efficacia.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Note</h2>

<ol>
<li id="fn1"><p><a href="https://www.istat.it/en/classification/codes-of-italian-municipalities-provinces-and-regions/">Codes of Italian municipalities</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copiato!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copiato!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Lorem ipsum</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>