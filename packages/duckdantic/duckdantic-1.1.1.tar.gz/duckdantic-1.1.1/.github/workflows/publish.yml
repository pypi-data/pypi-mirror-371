---
name: ğŸš€ Publish Release
on:
  release:
    types: [published]
permissions:
  contents: read
  id-token: write # Needed for PyPI trusted publishing
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true
jobs:
  publish:
    name: ğŸ“¦ Publish ${{ matrix.package }}
    runs-on: ubuntu-latest
    env:
      ACTIONS_STEP_DEBUG: ${{ secrets.ACTIONS_DEBUG || 'false' }}
    strategy:
      matrix:
        package:
          - haive-core
          - haive-agents
          - haive-games
          - haive-tools
          - haive-prebuilt
          - haive-dataflow
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GH_TOKEN }}
      - name: ğŸ“¦ Get Package Poetry Info
        id: poetry
        uses: ./.github/actions/get-package-poetry-info
        with:
          package: ${{ matrix.package }}
      - name: ğŸ§¾ Echo Package Metadata
        run: |
          echo "ğŸ“¦ Name:        ${{ steps.poetry.outputs.name }}"
          echo "ğŸ”– Version:     ${{ steps.poetry.outputs.version }}"
          echo "ğŸ§‘ Authors:     ${{ steps.poetry.outputs.authors || 'N/A' }}"
          echo "ğŸ“„ License:     ${{ steps.poetry.outputs.license || 'N/A' }}"
          echo "ğŸ“ Description: ${{ steps.poetry.outputs.description || 'N/A' }}"
          echo "ğŸŒ Homepage:    ${{ steps.poetry.outputs.homepage || 'N/A' }}"
          echo "ğŸ”— Repository:  ${{ steps.poetry.outputs.repository || 'N/A' }}"
          echo "ğŸ“š Docs:        ${{ steps.poetry.outputs.documentation || 'N/A' }}"
          echo "ğŸ· Classifiers: ${{ steps.poetry.outputs.classifiers || 'N/A' }}"
      - name: ğŸ Set up Python ${{ steps.poetry.outputs.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.poetry.outputs.python }}
          cache: poetry
      - name: ğŸ›  Install Poetry
        run: pipx install poetry==2.1.0
      - name: ğŸ” Configure PyPI Credentials
        run: poetry config pypi-token.pypi ${{ secrets.PYPI_TOKEN }}
      - name: ğŸ“¦ Build Package (No Publish)
        run: |
          cd packages/${{ matrix.package }}
          poetry build --format wheel
      - name: ğŸ“¤ Upload Package as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-dist
          path: packages/${{ matrix.package }}/dist/
