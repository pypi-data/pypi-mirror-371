"use strict";(self.webpackChunklino_react=self.webpackChunklino_react||[]).push([[2298,6368,7211],{2341:(t,e,s)=>{s.r(e),s.d(e,{Context:()=>d,Delegate:()=>x,ROUTES:()=>r,name:()=>n});var a=s(1151),i=s(6606),o=s(7479);const n="NavigationControl",r={home:"/",actor:"/api/:packId/:actorId/:pk?/:fieldName?"},c={},l=window.Lino,h=(0,i.RegisterImportPool)({u:Promise.resolve().then(s.bind(s,1367)),queryString:Promise.resolve().then(s.bind(s,9320)),rrd:Promise.all([s.e(7236),s.e(7185)]).then(s.bind(s,6994)),_:Promise.resolve().then(s.t.bind(s,1956,23))});class d extends i.DynDep{constructor(...t){return super(...t),_.call(this),this}async prepare(){await super.prepare(),this.ex._=this.ex._.default}computeGlobals(){this.globals=c,c.hasOwnProperty("isMobile")||(c.isMobile=this.ex.u.isMobile(),c.currentInputWindowType=a.WINDOW_TYPE_UNKNOWN,c.currentInputRowIndex=0,c.currentInputTabIndex=0,c.panels={},this.localStorageSize())}onReady({APP:t,rs:e,slave:s=!1,root:a,next:i}){this.computeGlobals=this.computeGlobals.bind(this),this.APP=t,this.value={},this.paramNames=[],this.root=a,this.isSlave=s,this.parent=null,this.children={},this.delegate={},this.static={actorData:null},this.addDelegate=this.addDelegate.bind(this),this.actorDependentParams=this.actorDependentParams.bind(this),this.assertAndReflect=this.assertAndReflect.bind(this),this.attachDataContext=this.attachDataContext.bind(this),this.basicContext=u.bind(this),this.build=this.build.bind(this),this.buildURLContext=p.bind(this),this.computeDefaults=this.computeDefaults.bind(this),this.copy=this.copy.bind(this),this.getActorData=this.getActorData.bind(this),this.isModified=this.isModified.bind(this),this.newSlug=this.newSlug.bind(this),this.onLeafMount=this.ex.u.debounce(this.onLeafMount.bind(this),300),this.paramChange_Action=this.paramChange_Action.bind(this),this.pushStatus=this.pushStatus.bind(this),this.reflect=this.reflect.bind(this),this.removeDelegate=this.removeDelegate.bind(this),this.setActionHandler=this.setActionHandler.bind(this),this.setContextType=this.setContextType.bind(this),this.setParent=this.setParent.bind(this),this.setRoot=this.setRoot.bind(this),this.storeDetaultInitialize=this.storeDetaultInitialize.bind(this),this.actionHandler=new o.ActionHandler({context:this,next:t=>{this.history=new P(this,e),this.computeGlobals(),this.createGettersSG(),c.hasOwnProperty("currentInputAHRefName")||(c.currentInputAHRefName=t.refName),i(this)}})}matchActorPath(t){return this.ex.rrd.matchPath(r.actor,t)}localStorageSize(){if(!c.localStorageTotal){for(var t=0,e="1".repeat(1e4);;t++)try{window.localStorage.setItem("ONES",e),e+="1".repeat(1e5)}catch(t){c.localStorageTotal=Math.round(JSON.stringify(window.localStorage).length/1024*2),window.localStorage.removeItem("ONES");break}c.localStorageFreeThreshold=Math.round(.2*c.localStorageTotal)}return c.localStorageUsed=Math.round(JSON.stringify(window.localStorage).length/1024*2),c.localStorageAvailable=c.localStorageTotal-c.localStorageUsed,{total:c.localStorageTotal,used:c.localStorageUsed,free:c.localStorageAvailable,threshold:c.localStorageFreeThreshold}}addDelegate(t,e){this.delegate[t]=e}async build(t){let e=await this.buildURLContext(this.APP.location.pathname),s=this.actionHandler.parser.parse(this.APP.location.search);if(s.clone){const t=s.clone;this.clone=t,t.windowGlobals&&await this.history.replaceByType(t.windowGlobals,a.PARAM_TYPE_WINDOW,!1,!0),t.children&&this.copyChildClones(t.children),s=t.params}const i=s&&s.rs||e.params.rs;if(i&&this.history.has(i)&&Object.assign(e.params,this.history.getState(i)),Object.assign(e.params,s),!t)return e;t(e)}copyChildClones(t){t.forEach((t=>Object.keys(t).forEach((e=>this.static[e]=t[e]))))}disabled(t){return this.contextType===a.CONTEXT_TYPE_SINGLE_ROW&&this.dataContext.mutableContext.data&&(this.dataContext.mutableContext.data.disabled_fields[t]||!1)}computeDefaults(t,e,s,i){let o=this.ex.u.getDisplayMode(e,t);i&&(s.toolbarState=e.hide_top_toolbar?a.TOOLBAR_STATE_HIDDEN:this.globals.isMobile?a.TOOLBAR_STATE_PARTIALLY_VISIBLE:a.TOOLBAR_STATE_VISIBLE),s.pvPVisible=!e.params_panel_hidden;let n=e.available_display_modes;if(s[a.URL_PARAM_DISPLAY_MODE]=e.default_action.endsWith(".show")||void 0!==s.pk&&void 0!==e.col?a.DISPLAY_MODE_DETAIL:n.includes(o)?o:a.DISPLAY_MODE_TABLE,s[a.URL_PARAM_WINDOW_TYPE]=a.DM_WT_MAP[s[a.URL_PARAM_DISPLAY_MODE]],"show"===e.default_action&&(s.pk=-99998),s.showableColumns=new Map,s.rowReorder=!1,e.col&&e.col.filter((t=>!t.hidden)).forEach(((t,e)=>{s.showableColumns.set(t.fields_index,t.name)})),e.col){e.col.filter((t=>"dndreorder"===t.name)).length&&(s.rowReorder=!0)}!this.filled(s.pk)||this.value.actorId===s.actorId&&this.value.packId===s.packId&&this.filled(this.value.pk)?this.filled(s.pk)&&(s.detailNav=this.value.detailNav):(s.detailNav=new Map,s.rs||(s.rs=this.newSlug()),s.detailNav.set(s.pk,s.rs))}copy(){const t=e=>{let s=e;if(e instanceof Map){s=new Map;for(const[a,i]of e)s.set(a,t(i))}else Array.isArray(e)?(s=[],e.forEach((e=>s.push(t(e))))):e instanceof Object&&(s={},Object.keys(e).forEach((a=>s[a]=t(e[a]))));return s},e={};return this.paramNames.forEach((s=>e[s]=t(this.value[s]))),e}isModified(){if(this.void)return!1;if(!this.dataContext)return!1;if(this.dataContext.isModified())return!0;for(const t of Object.values(this.children))if(t.isModified())return!0;return!1}makePath(t){return`${t.path}?${this.ex.queryString.default.stringify({rs:t.rs,mk:t.mk,mt:t.mt})}`}paramChange_Action(t,e){let s={};return t.noreload&&!e.noreload?s.render=!0:e[a.URL_PARAM_DISPLAY_MODE]!==t[a.URL_PARAM_DISPLAY_MODE]||e.path!==t.path?s.reload=!0:e[a.URL_PARAM_START]===t[a.URL_PARAM_START]&&e[a.URL_PARAM_LIMIT]===t[a.URL_PARAM_LIMIT]&&e[a.URL_PARAM_MASTER_PK]===t[a.URL_PARAM_MASTER_PK]&&e[a.URL_PARAM_MASTER_TYPE]===t[a.URL_PARAM_MASTER_TYPE]&&e[a.URL_PARAM_SORT]===t[a.URL_PARAM_SORT]&&e[a.URL_PARAM_SORTDIR]===t[a.URL_PARAM_SORTDIR]&&e[a.URL_PARAM_FILTER]===t[a.URL_PARAM_FILTER]&&this.ex._.isEqual(e[a.URL_PARAM_PARAM_VALUES],t[a.URL_PARAM_PARAM_VALUES])&&this.ex._.isEqual(e[a.URL_PARAM_GRIDFILTER],t[a.URL_PARAM_GRIDFILTER])||(s.refresh=!0),s}pushStatus(t,e,s){return s=s||this.static.actorData,this.filled(t.base_params)&&(this.filled(t.base_params.mk)&&(e.mk=t.base_params.mk),this.filled(t.base_params.mt)&&(e.mt=t.base_params.mt)),s&&this.filled(t.param_values)&&(e[a.URL_PARAM_PARAM_VALUES]=this.ex.u.pvObj2array(t.param_values,s.params_fields)),this.filled(t.record_id)&&(e[a.URL_PARAM_SELECTED]=[parseInt(t.record_id)]),this.filled(t.data)&&Object.assign(e,t.data),this.filled(t.clickCatch)&&(e.clickCatch=t.clickCatch),e}filled(t){return![null,void 0,""].includes(t)}actorDependentParams(t,e){t.hasDetail=!!e.detail_action}assertAndReflect({lazy:t,actorData:e,params:s}){const i=async()=>{await this.root.iSetState({initialized:!1}),this.setActorData(e),await this.reflect({params:s,param_type:a.PARAM_TYPE_VIEW,clean:!0,browserPush:!t})};this.isModified()?(t&&window.history.pushState(null,null,`/#${this.value.path}?rs=${this.value.rs}`),this.actionHandler.discardModDConfirm({agree:e=>{t?window.history.go(-1):i()},disagree:t=>{}})):i()}createGettersSG(){this.paramNames.push(...a.SITE_GLOBALS_KEYS),a.SITE_GLOBALS_KEYS.forEach(((t,e)=>Object.defineProperty(this.value,t,{get:()=>this.history.getState(a.PARAM_TYPE_GLOBAL)[t]})))}createGetters({params:t,param_type:e=a.PARAM_TYPE_VIEW}){const s=(t,e)=>{this.paramNames.push(t),Object.defineProperty(this.value,t,{get:()=>this.history.state.value[e][t]})};e===a.PARAM_TYPE_IMPLICIT?Object.keys(t).forEach(((e,i)=>{e!==a.PARAM_TYPE_GLOBAL&&Object.keys(t[e]).forEach(((t,a)=>{this.defined(t)||s(t,e)}))})):Object.keys(t).forEach(((t,a)=>{this.defined(t)||s(t,e)}))}shallowCopy(t){const e=Object.create(Object.getPrototypeOf(t)),s=Object.getOwnPropertyDescriptors(t);return Object.defineProperties(e,s),e}async reflect({params:t,browserPush:e=!1,rebuild:s=!1,silent:i=!1,param_type:o=a.PARAM_TYPE_VIEW,clean:n=!1}){if(n&&(this.history.state.value[a.PARAM_TYPE_VIEW]={},this.paramNames=[],this.value={},this.createGettersSG(),this.createGetters({params:this.history.state.value,param_type:a.PARAM_TYPE_IMPLICIT})),s&&(this.value=this.shallowCopy(this.value)),this.value.controller=this,o===a.PARAM_TYPE_IMPLICIT)for(var r in Object.keys(t))await this.history.state.update(t[r],r);else await this.history.state.update(t,o);this.createGetters({params:t,param_type:o}),!this.isSlave&&e&&this.APP.navigate(this.makePath(this.value)),i||await this.root.iSetState({context:this.value,hasActor:this.value.hasActor,initialized:!0})}removeDelegate(t){delete this.delegate[t]}setParent(t){this.parent&&delete this.parent.children[this.actionHandler.refName],this.parent=t,t.children[this.actionHandler.refName]=this}storeDetaultInitialize(t){this.isSlave&&(t.wid=this.parent.value.wid),t.sortField=null,t.sortOrder=0,t.pvPVisible=!1,t[a.URL_PARAM_SELECTED]=[],t.gridFilters=new Map,t.filter=[]}}d.requiredModules=["u","queryString","rrd","_"],d.iPool=h;var _=function(){this.onLeafMount=()=>{this.contextType===a.CONTEXT_TYPE_ACTION&&Object.values(this.dataContext.refStore.Leaves).sort(((t,e)=>t.props.tabIndex<e.props.tabIndex&&t.hasOwnProperty("focus")&&!t.disabled()?-1:t.props.tabIndex>e.props.tabIndex&&e.hasOwnProperty("focus")&&!e.disabled()?1:0))[0].focus()},this.setActorData=t=>{t&&(this.static.actorData&&delete c.panels[this.static.actorData.id],this.static.actorData=t,c.panels[this.static.actorData.id]=this.root)},this.attachDataContext=t=>this.dataContext=t,this.getSiteData=async(t,e)=>await this.getIDBData(t,e),this.getActorData=async t=>await this.getIDBData(this.getActorKey(t),this.getActorURL(t)),this.getActorKey=t=>{let e=this.APP.state.user_settings;return`ActorData_${e.su_user_type||e.user_type}_${this.APP.data.selectedLanguage||e.site_lang}_${e.site_name}_${t}`},this.getActorURL=t=>{let e=this.APP.state.user_settings,s="/media/cache/json/";return s+=this.APP.state.site_data.no_user_model?`Lino_${t}_${this.APP.data.selectedLanguage||e.site_lang}.json`:`Lino_${t}_${e.su_user_type||e.user_type}_${this.APP.data.selectedLanguage||e.site_lang}.json`,s},this.iDBOStore=()=>this.APP.cacheDB.transaction(this.APP.storageName,"readwrite").objectStore(this.APP.storageName),this.iDBTransactionRequest=(t,...e)=>this.iDBOStore()[t](...e),this.iDBTransactionResult=async(t,...e)=>{let s=this.iDBTransactionRequest(t,...e);return await new Promise((t=>{s.onsuccess=e=>t(s.result)})).then((t=>t))},this.iDBclear=async()=>await this.iDBTransactionResult("clear"),this.iDBdelete=async t=>await this.iDBTransactionResult("delete",t),this.iDBget=async t=>await this.iDBTransactionResult("get",t),this.iDBput=async(t,e)=>await this.iDBTransactionResult("put",t,e),this.getIDBData=async(t,e)=>{let s=await this.iDBget(t);const i=async()=>{if(s=await this.actionHandler.silentFetch({path:e+`?v=${Math.round(1e6*Math.random()).toString()}`}),l[a.URL_PARAM_LINO_VERSION]<s[a.URL_PARAM_LINO_VERSION])return this.APP.reload(),s;if(l[a.URL_PARAM_LINO_VERSION]!==s[a.URL_PARAM_LINO_VERSION])throw new Error('Invalid lv marks. RUN "pm buildcache" and restart the server.');return await this.iDBput(s,t),s};return s?l[a.URL_PARAM_LINO_VERSION]===s[a.URL_PARAM_LINO_VERSION]?s:l[a.URL_PARAM_LINO_VERSION]<s[a.URL_PARAM_LINO_VERSION]?(this.APP.reload(),s):await i():await i()},this.newSlug=()=>{let t=Math.round(1e9*Math.random());return t in localStorage?this.newSlug():t},this.defined=t=>this.paramNames.includes(t),this.fillPlaceHolder=(t,e,s)=>{this.defined(e)?this.history.state.value[t][e]=s:this.value[e]=s},this.setActionHandler=t=>this.actionHandler=t,this.setContextType=t=>this.contextType=t,this.setRoot=t=>{this.root=t}};async function u(t,e){const{sanitize:s}=this.actionHandler.parser;let a,i={path:t};this.storeDetaultInitialize(i);let o=this.ex.rrd.matchPath(r.actor,t);if(Object.assign(i,o.params),i.pk=this.filled(i.pk)?s(i.pk):void 0,a=await this.getActorData(`${i.packId}.${i.actorId}`),this.actorDependentParams(i,a),!e)return{params:i,actorData:a};e({params:i,actorData:a})}async function p(t,e){const{sanitize:s}=this.actionHandler.parser;let a=this.APP.state.site_data,i={editing_mode:!1,hasActor:"/"!==t,path:t},o=null;if(this.storeDetaultInitialize(i),i.hasActor){let e=this.ex.rrd.matchPath(r.actor,t);if(e)Object.assign(i,e.params);else{if("/"!==t)throw new Error(`InvalidRouterPath: ${t}`);i.packId="system",i.actorId="Dashboard"}i.pk=this.filled(i.pk)?s(i.pk):void 0,o=await this.getActorData(`${i.packId}.${i.actorId}`),i.window_layout=e?o.window_layout:a.choicelists["system.DashboardLayouts"].find((t=>t.value===(this.APP.state.user_settings.dashboard_layout||"default"))).window_layout,this.actorDependentParams(i,o),this.computeDefaults(this.root.contextEntry.offsetWidth/this.root.chInPx.offsetWidth,o,i,!0),this.ex.u.fillParamDefaults(i,o)}if(!e)return{params:i,actorData:o};e({params:i,actorData:o})}class A{constructor({history:t,rs:e}){const{context:s,getState:i}=t,o={};this.history=t,this.context=s;const n=i(a.PARAM_TYPE_GLOBAL);s.isSlave||s.filled(e)||(e=s.newSlug()),o[a.PARAM_TYPE_VIEW]={rs:e},s.filled(e)&&t.has(e)&&(o[a.PARAM_TYPE_VIEW]=i(e)),o[a.PARAM_TYPE_WINDOW]={},s.isSlave?o[a.PARAM_TYPE_WINDOW]=s.APP.URLContext.history.state.value[a.PARAM_TYPE_WINDOW]:s.filled(o[a.PARAM_TYPE_VIEW].wid)&&t.has(o[a.PARAM_TYPE_VIEW].wid)?o[a.PARAM_TYPE_WINDOW]=i(o[a.PARAM_TYPE_VIEW].wid):s.filled(n.latestWID)&&t.has(n.latestWID)&&(o[a.PARAM_TYPE_WINDOW]=i(n.latestWID)),s.createGetters({params:o,param_type:a.PARAM_TYPE_IMPLICIT}),this.value=o}async update(t,e=a.PARAM_TYPE_VIEW){const{context:s,history:i,value:o}=this,n=i.getState(a.PARAM_TYPE_GLOBAL),r=(o[a.PARAM_TYPE_WINDOW],o[a.PARAM_TYPE_VIEW]);if(e===a.PARAM_TYPE_GLOBAL)return void i.putState(a.PARAM_TYPE_GLOBAL,Object.assign(n,t));Object.assign(o[e],t);let c=r.rs;if(e===a.PARAM_TYPE_WINDOW)s.filled(r.wid)||await i.replaceByType({wid:s.newSlug()},a.PARAM_TYPE_VIEW,!1,!0),c=r.wid;else{if(e!==a.PARAM_TYPE_VIEW)throw new Error(`Invalid parameter type: ${e}`);s.isSlave&&(c=i.slaveContextStoreKey())}await this.update({latestWID:r.wid},a.PARAM_TYPE_GLOBAL);let l=i.stateStore.getObject("rsOrder");if(i.has(c))return l=l.filter((t=>c!==t)),l.push(c),i.stateStore.setObject("rsOrder",l),void i.putState(c,o[e]);const h=()=>{const{free:t,threshold:e}=s.localStorageSize();t<e&&(i.stateStore.removeItem(l.shift()),h())};h(),l.push(c),i.putState(c,o[e]),i.stateStore.setObject("rsOrder",l)}}class P{constructor(t,e){R.call(this),this.stateStore=window.localStorage,this.context=t,this.has=this.has.bind(this),this.load=this.load.bind(this),this.popFromStore=this.popFromStore.bind(this),this.push=this.push.bind(this),this.pushLazy=this.pushLazy.bind(this),this.pushPath=this.pushPath.bind(this),this.replace=this.replace.bind(this),"isMobile"in c||this.prepare(),this.state=new A({history:this,rs:e})}push({params:t,actorData:e}){const s=this.state.value[a.PARAM_TYPE_VIEW];if(t.path===s.path&&t[a.URL_PARAM_MASTER_PK]===s[a.URL_PARAM_MASTER_PK]&&t[a.URL_PARAM_MASTER_TYPE]===s[a.URL_PARAM_MASTER_TYPE])throw new Error("Action not allowed, does not have any effect on router path!");t.rs||(t.rs=this.context.newSlug()),t.wid||(t.wid=s.wid||this.context.newSlug()),t.clickCatch?window.open(`#${this.context.makePath(t)}`):this.context.assertAndReflect({lazy:!1,actorData:e,params:t})}pushLazy({params:t,actorData:e}){this.context.assertAndReflect({lazy:!0,actorData:e,params:t})}async pushPath({pathname:t,params:e,lazy:s=!1}={},a){let i=await this.context.buildURLContext(t);a&&(i.params=this.context.pushStatus(a,i.params,i.actorData)),Object.assign(i.params,e),s?this.pushLazy(i):this.push(i)}async replaceByType(t,e,s=!1,i=!1){e===a.PARAM_TYPE_VIEW&&this.context.value.noreload&&!t.noreload&&(t.noreload=!1),await this.context.reflect({params:t,param_type:e,rebuild:s,silent:i})}}var R=function(){this.state=null,this.prepare=()=>{this.has("rsOrder")||localStorage.setItem("rsOrder","[]"),this.has(a.PARAM_TYPE_GLOBAL)||localStorage.setItem(a.PARAM_TYPE_GLOBAL,"{}")},this.has=t=>t in this.stateStore,this.load=async({rs:t,lazy:e=!1})=>{const s=this.popFromStore(t),a=s.hasActor?await this.context.getActorData(`${s.packId}.${s.actorId}`):null;await this.context.root.iSetState({initialized:!1}),this.context.assertAndReflect({lazy:e,actorData:a,params:s})},this.popFromStore=t=>{const e=this.getState(t);return this.state.value[a.PARAM_TYPE_VIEW]=e,e},this.replaceStateByType=async(t,e)=>await this.replaceByType(t,e,!0),this.replace=async t=>await this.replaceByType(t,a.PARAM_TYPE_VIEW),this.replaceState=async t=>await this.replaceStateByType(t,a.PARAM_TYPE_VIEW),this.hardReplace=async t=>{await this.replaceState(t),this.context.root.setState({key:this.context.newSlug()})},this.contextStoreKey=()=>this.context.isSlave?this.slaveContextStoreKey():this.context.value.rs,this.slaveContextStoreKey=(t="")=>{t="_"+this.context.static.actorData.id+t;const e=this.context.parent;return e.value.rs?e.value.rs.toString()+t:e.history.slaveContextStoreKey(t)},this.putState=(t,e)=>this.stateStore.setObject(t,this.context.actionHandler.parser.sanitizeObjectUnparse(this.context.ex._.cloneDeep(e))),this.getState=t=>this.context.actionHandler.parser.sanitizeParse(this.stateStore.getObject(t))};class x{constructor(t,e){this.createProperty=this.createProperty.bind(this),this.id=e.newSlug(),this.context=e,e.addDelegate(this.id,this),this.root=t,this._values={},this.value={},Object.keys(e.value).forEach((t=>this.createProperty(t))),this.unset=this.unset.bind(this)}createProperty(t){Object.defineProperty(this.value,t,{get:()=>this._values.hasOwnProperty(t)?this._values[t]:this.context.value[t],set:e=>{this._values[t]=e}})}unset(){this.context.removeDelegate(this.id)}}},2292:(t,e,s)=>{s.r(e),s.d(e,{TransInit:()=>c,default:()=>l});var a=s(1151),i=s(1884),o=s(8682),n=s(9974),r=s(6433);const c=(t,e)=>{const s=new o.A;s.addDetector({name:"LinoLanguageDetector",lookup:e=>t.value[a.URL_PARAM_USER_LANGUAGE],cacheUserLanguage(e,s){t.fillPlaceHolder(a.PARAM_TYPE_WINDOW,a.URL_PARAM_USER_LANGUAGE,e),t.history.replaceByType({[a.URL_PARAM_USER_LANGUAGE]:e},a.PARAM_TYPE_WINDOW,!1,!0)}}),i.Ay.use(n.A).use(s).use(r.initReactI18next).init({debug:!1,load:"languageOnly",fallbackLng:window.Lino.i18nFallbackLng,keySeparator:!1,interpolation:{escapeValue:!1},react:{useSuspense:!0},backend:{loadPath:"/static/react/locales/{{lng}}/{{ns}}.json"},detection:{order:["queryString","cookie","LinoLanguageDetector","localStorage"],lookupQuerystring:a.URL_PARAM_USER_LANGUAGE,lookupCookie:a.URL_PARAM_USER_LANGUAGE,lookupLocalStorage:a.URL_PARAM_USER_LANGUAGE,caches:["LinoLanguageDetector","localStorage","cookie"]}}),e(i.Ay)},l=i.Ay},7479:function(__unused_webpack_module,exports,__webpack_require__){var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,s,a){void 0===a&&(a=s);var i=Object.getOwnPropertyDescriptor(e,s);i&&!("get"in i?!e.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,a,i)}:function(t,e,s,a){void 0===a&&(a=s),t[a]=e[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||(ownKeys=function(t){return ownKeys=Object.getOwnPropertyNames||function(t){var e=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[e.length]=s);return e},ownKeys(t)},function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s=ownKeys(t),a=0;a<s.length;a++)"default"!==s[a]&&__createBinding(e,t,s[a]);return __setModuleDefault(e,t),e}),ownKeys;Object.defineProperty(exports,"__esModule",{value:!0}),exports.ActionHandler=exports.URLParser=void 0;const constants=__importStar(__webpack_require__(1151)),Base_1=__webpack_require__(6606),preprocessors_1=__webpack_require__(8267),exModulePromises={queryString:Promise.resolve().then((()=>__importStar(__webpack_require__(9320)))),weakKey:Promise.resolve().then((()=>__importStar(__webpack_require__(2406)))),_:Promise.resolve().then((()=>__importStar(__webpack_require__(1956)))),whatwgFetch:Promise.resolve().then((()=>__importStar(__webpack_require__(9853)))),AbortController:Promise.resolve().then((()=>__importStar(__webpack_require__(1181)))),u:Promise.resolve().then((()=>__importStar(__webpack_require__(1367)))),i18n:Promise.resolve().then((()=>__importStar(__webpack_require__(2292))))};(0,Base_1.RegisterImportPool)(exModulePromises);class URLParser extends Base_1.DynDep{constructor(){super(...arguments),this.parseShallow=(t,{sanitizeValue:e=!0}={})=>{t.startsWith("?")&&(t=t.slice(1));const s=this.queryString.parse(t);return e&&Object.keys(s).forEach((t=>s[t]=this.sanitize(s[t]))),s},this.parse=(t,{sanitizeValue:e=!0}={})=>{t.startsWith("?")&&(t=t.slice(1));let s=this.queryString.parse(t);return Object.keys(s).forEach((t=>{s[t]=this.sanitizeParse(s[t],e)})),s},this.sanitize=t=>{let e;if("string"==typeof t){let s=t.match(constants.DATE_EXP);if(null!==s)return t;if(s=t.match(constants.TIME_EXP),null!==s)return t;if(e=parseFloat(t),!this.ex.u.isNaN(e))return e;if(e=t.toLowerCase(),"true"===e)return!0;if("false"===e)return!1}return t},this.sanitizeArrayUnparse=t=>(t.forEach(((e,s)=>t[s]=this.sanitizeUnparse(e))),t),this.sanitizeMapUnparse=t=>{let e=this.sanitizeObjectUnparse(Object.fromEntries(t));return e.keyOrder=Array.from(t.keys()),e},this.sanitizeObjectUnparse=t=>(Object.keys(t).forEach((e=>t[e]=this.sanitizeUnparse(t[e]))),t),this.sanitizeParse=(t,e)=>{if("string"==typeof t&&t.startsWith(constants.STR_JSON_ITENT)&&(t=JSON.parse(t.split(constants.STR_JSON_ITENT)[1]),e=!1),Array.isArray(t))t.forEach(((s,a)=>t[a]=this.sanitizeParse(s,e)));else if(t instanceof Object){if(Object.keys(t).forEach((s=>t[s]=this.sanitizeParse(t[s],e))),t.hasOwnProperty("keyOrder")){let e=new Map;t.keyOrder.forEach((s=>e.set(s,t[s]))),t=e}}else e&&(t=this.sanitize(t));return t},this.sanitizeUnparse=t=>t instanceof Map?this.sanitizeMapUnparse(t):Array.isArray(t)?this.sanitizeArrayUnparse(t):t instanceof Object?this.sanitizeObjectUnparse(t):t,this.stringify=(t,e=!1)=>this.queryString.stringify(this.stringifyNONPrimitives(this.sanitizeObjectUnparse(t),e)),this.stringifyNONPrimitives=(t,e=!0)=>(Object.keys(t).forEach((s=>{let a=t[s];s===constants.URL_PARAM_GRIDFILTER?t[s]=(e?constants.STR_JSON_ITENT:"")+JSON.stringify(a):Array.isArray(a)?a.forEach(((t,s)=>{t instanceof Object&&(a[s]=(e?constants.STR_JSON_ITENT:"")+JSON.stringify(t))})):a instanceof Object&&(t[s]=(e?constants.STR_JSON_ITENT:"")+JSON.stringify(a))})),t)}async prepare(){await super.prepare(),this.queryString=this.ex.queryString.default}onReady({next:t}){t(this)}}exports.URLParser=URLParser,URLParser.requiredModules=["queryString","u"],URLParser.iPool=exModulePromises;class ActionHandler extends Base_1.DynDep{constructor(){super(...arguments),this.clearMod=()=>{this.context.dataContext.clearMod();for(const t of Object.values(this.context.children)){let e=t.dataContext;e&&e.clearMod()}},this.clearRequestPool=()=>{this.abortController.abort(),this.abortController=new this.ex.AbortController},this.cloneState=({flags:t=constants.FLAG_CLONE_URL|constants.FLAG_CLONE_UI|constants.FLAG_CLONE_DATA,recursive:e=!1}={})=>{let s={clone:!0};if(t&constants.FLAG_CLONE_DATA&&this.copyData(s),t&constants.FLAG_CLONE_UI&&this.getUIConfigParams(Object.assign(s,{params:{}}).params),t&constants.FLAG_CLONE_URL&&(t&constants.FLAG_CLONE_UI||Object.assign(s,{params:{}}),Object.assign(s,{windowGlobals:{}}),this.getBasics(s.params),this.getParams(s)),e){const a=Object.values(this.context.children);a.length&&(s.children=a.map((s=>({[s.static.actorData.id]:s.actionHandler.cloneState({flags:t,recursive:e})}))))}return s},this.copyContext=(t,e={})=>{const s=this.cloneState({flags:constants.FLAG_CLONE_UI|constants.FLAG_CLONE_URL});Object.assign(s.params,e),t.history.pushPath({pathname:s.params.path,params:s.params})},this.copyData=t=>(t.mutableData={...this.context.dataContext.mutableContext},t.immutableData={...this.context.dataContext.contextBackup},t),this.URLAppendPKFromSR=(t,e)=>{const s=this.context.filled(e)&&e.length?e[0]:null;return this.context.filled(s)&&(t+=`/${s}`),t},this.executeAction=async({action:t,actorId:e,status:s,preprocessedStack:a,response_callback:i,rowIndex:o,pollContext:n})=>{delete a.callback;let r=a;"GET"===t.http_method&&(r[constants.URL_PARAM_FORMAT]=constants.URL_FORMAT_JSON);const c=await this.context.getActorData(e);let l=`api/${e.split(".").join("/")}`;t.full_name!==c.delete_action&&(l=this.URLAppendPKFromSR(l,r[constants.URL_PARAM_SELECTED]));const h=e=>{"GET"===t.http_method?this.handledFetch({path:`${l}?${this.parser.stringify(e)}`,response_callback:i}):this.hasFiles()?this.submitFiles(e):this.XHRPutPost({path:l,body:e,response_callback:i},t.http_method)};if(s&&s.rqdata&&s.xcallback)return s.rqdata["xcallback__"+s.xcallback.xcallback_id]=s.xcallback.choice,void h(s.rqdata);let d=Object.assign(this.mustHaveParams(),this.getModifiedData(o));const _=this.context.value.hasActor&&e===this.context.static.actorData.id;_&&Object.assign(d,this.commonParams()),(n||_)&&Object.assign(d,this.getParams()),Object.assign(d,r),s&&this.context.filled(s.fv)&&!t.window_action&&Object.assign(d,{fv:s.fv}),h(d)},this.getHolders=t=>{let e,s;return t.clone?(e=t.params,s=t.windowGlobals):(e=t,s=t),{viewHolder:e,windowHolder:s}},this.defaultStaticParams=(t={})=>(t[constants.URL_PARAM_MASTER_PK]=this.context.value[constants.URL_PARAM_MASTER_PK],t[constants.URL_PARAM_MASTER_TYPE]=this.context.value[constants.URL_PARAM_MASTER_TYPE],t[constants.URL_PARAM_LINO_VERSION]=window.Lino[constants.URL_PARAM_LINO_VERSION],t[constants.URL_PARAM_REQUESTING_PANEL]=this.refName,t),this.mustHaveParams=(t={})=>(t[constants.URL_PARAM_SUBST_USER]=this.context.value[constants.URL_PARAM_SUBST_USER],t[constants.URL_PARAM_USER_LANGUAGE]=this.context.value[constants.URL_PARAM_USER_LANGUAGE],t),this.commonParams=(t={})=>{const{viewHolder:e,windowHolder:s}=this.getHolders(t);return this.mustHaveParams(s),e[constants.URL_PARAM_WINDOW_TYPE]=this.context.value[constants.URL_PARAM_WINDOW_TYPE],e[constants.URL_PARAM_DISPLAY_MODE]=this.context.value[constants.URL_PARAM_DISPLAY_MODE],this.defaultStaticParams(e),t},this.defaultParams=(t={})=>{const{viewHolder:e,windowHolder:s}=this.getHolders(t);return this.commonParams(t),this.context.static.actorData&&this.context.static.actorData.use_detail_params_value?e[constants.URL_PARAM_PARAM_VALUES]=this.context.APP.URLContext.value[constants.URL_PARAM_PARAM_VALUES]:e[constants.URL_PARAM_PARAM_VALUES]=this.context.value[constants.URL_PARAM_PARAM_VALUES],e[constants.URL_PARAM_FILTER]=this.context.value[constants.URL_PARAM_FILTER],t},this.masterRelateForSlave=()=>{const{context:t}=this;return{[constants.URL_PARAM_MASTER_PK]:constants.ABSTRACT_PRIMARY_KEYS.includes(t.value.pk)?t.dataContext.mutableContext.id:t.value.pk,[constants.URL_PARAM_MASTER_TYPE]:t.static.actorData.content_type}},this.discardModDConfirm=({agree:t=t=>{},disagree:e=t=>{}})=>{let s=this.context.APP.dialogFactory,a=this.context.newSlug().toString();s.createCallback({actionHandler:this,agree:e=>{this.clearMod(),t(e),s.removeCallback(a)},disagree:t=>{e(t),s.removeCallback(a)},factory:s,id:a,simple:!0,title:this.ex.i18n.t("Confirmation"),message:this.ex.i18n.t("Discard changes to current record?")})},this.multiRowParams=t=>{t[constants.URL_PARAM_START]=this.context.value[constants.URL_PARAM_START],t[constants.URL_PARAM_LIMIT]=this.context.value[constants.URL_PARAM_LIMIT],t[constants.URL_PARAM_SORT]=this.context.value[constants.URL_PARAM_SORT],t[constants.URL_PARAM_SORTDIR]=this.context.value[constants.URL_PARAM_SORTDIR];let e=this.context.value[constants.URL_PARAM_GRIDFILTER];return e.length&&(t[constants.URL_PARAM_GRIDFILTER]=e),t},this.getAction=(t,e=!0)=>{const s=this.context.APP.state.site_data.action_definitions[t],a={[constants.URL_PARAM_ACTION_NAME]:s[constants.URL_PARAM_ACTION_NAME]};return e&&this.preprocess(s.preprocessor,a),{action:s,preprocessedStack:a}},this.getCallback=t=>"submit_detail"===t?this.submitDetailCallback:"sign_in"===t?e=>{e[constants.URL_PARAM_ACTION_NAME]=t}:t=>{},this.getDefaultContextPath=()=>{let t=this.context.value;return{pathname:"Dashboard"===t.actorId?"api/system/Dashboard":t.path.slice(1),params:{[constants.URL_PARAM_FORMAT]:constants.URL_FORMAT_JSON}}},this.getGridFilters=()=>Array.from(this.context.value.gridFilters.values()).filter((t=>this.context.filled(t.value))),this.getModifiedData=t=>{let e={};if(!this.context.dataContext)return e;if(this.context.contextType===constants.CONTEXT_TYPE_ACTION)e={...this.context.dataContext.mutableContext.data},delete e.disabled_fields,delete e.disable_editing;else if([void 0,constants.DISPLAY_MODE_DETAIL].includes(t)){let t=this.context.dataContext.mutableContext.data;this.context.dataContext.mutableContext.modified.forEach((s=>{e[s]=t[s],this.context.filled(e[s])||(e[s]=""),t.hasOwnProperty(s+"Hidden")&&(e[s+"Hidden"]=t[s+"Hidden"])}))}else{let s=this.context.static.actorData.col,a=this.context.dataContext.mutableContext.rows[t];this.context.dataContext.mutableContext.modifiedRows[t].forEach(((t,i)=>{let o=this.context.value.showableColumns.get(t),n=s.find((e=>e.fields_index===t)).fields_index_hidden;this.context.filled(n)&&(e[o+"Hidden"]=a[n]),e[o]=a[t]}))}return e},this.getBasics=t=>(t.path=this.context.value.path,t.hasActor=this.context.value.hasActor,t),this.getParams=(t={})=>(t=this.defaultParams(t),constants.DISPLAY_MODE_DETAIL!==this.context.value[constants.URL_PARAM_DISPLAY_MODE]?this.multiRowParams(t.clone?t.params:t):t),this.getPath=t=>{void 0===t&&(t=this.getDefaultContextPath());let e=this.getParams();return Object.assign(e,t.params),`${t.pathname}?${this.parser.stringify(e)}`},this.getUIConfigParams=(t={})=>(t.editing_mode=this.context.value.editing_mode,t.pvPVisible=this.context.value.pvPVisible,t.showableColumns=this.context.value.showableColumns,t.sortField=this.context.value.sortField,t.sortOrder=this.context.value.sortOrder,t.tab=this.context.value.tab,t.toolbarState=this.context.value.toolbarState,t),this.reload=()=>this.refresh(!0),this.refresh=(t=!1)=>{this.context.dataContext.root.controller.abort(),this.context.dataContext.root.controller=new this.ex.AbortController,this.context.setContextType(this.context.filled(this.context.value.fieldName)?constants.CONTEXT_TYPE_TEXT_FIELD:this.context.value[constants.URL_PARAM_DISPLAY_MODE]===constants.DISPLAY_MODE_DETAIL?constants.CONTEXT_TYPE_SINGLE_ROW:constants.CONTEXT_TYPE_MULTI_ROW),this.handledFetch({path:this.getPath(),signal:this.context.dataContext.root.controller.signal,response_callback:e=>{null!==e&&([constants.CONTEXT_TYPE_SINGLE_ROW,constants.CONTEXT_TYPE_TEXT_FIELD].includes(this.context.contextType)&&(e.hasOwnProperty("success")||(e.success=!0)),this.context.dataContext.set(e,!1,{loading:!1},(e=>{const{context:s}=this;if(s.contextType===constants.CONTEXT_TYPE_SINGLE_ROW)s.history.replace({[constants.URL_PARAM_SELECTED]:[e.id]});else if(s.contextType===constants.CONTEXT_TYPE_MULTI_ROW){let t=s.static.actorData.pk_index,a=[];e.rows.forEach((e=>{s.value[constants.URL_PARAM_SELECTED].includes(e[t])&&a.push(e[t])})),s.history.replace({[constants.URL_PARAM_SELECTED]:a})}if(t){const{toolbar:t}=s.dataContext.root;t&&t.setState({key:s.newSlug()})}})))}},(()=>{t?this.context.dataContext.root.setState({displayMode:null,loading:!0}):this.context.dataContext.root.setState({loading:!0})}))},this.refreshDelayedValue=t=>{let e=this.context.dataContext.refStore.slaveLeaves;!0===t?Object.values(e).forEach((t=>t.update())):e[t]&&e[t].update()},this.fetch=async({path:t,signal:e,silent:s=!1})=>(s||this.context.APP.setLoadMask(),await this.ex.fetchPolyfill(t,{signal:e}).then(this.handleAjaxResponse).catch((()=>null))),this.silentFetch=async({path:t,signal:e})=>await this.fetch({path:t,signal:e,silent:!0}),this.handledFetch=async({path:t,signal:e,silent:s=!1,response_callback:a},i=()=>{})=>{const o=()=>{i(),this.fetch({path:t,signal:e,silent:s}).then((async t=>{await this.handleActionResponse({response:t,response_callback:a})}))};s||this.context.contextType===constants.CONTEXT_TYPE_ACTION||!this.context.isModified()?o():this.discardModDConfirm({agree:o})},this.handleActionResponse=async({response,response_callback})=>{if(response.version_mismatch)return void this.context.APP.reload();let aH=this;if(response.info_message&&console.log(response.info_message),response.debug_message&&console.log(response.debug_message),response.warning_message&&console.warn(response.warning_message),response_callback&&response_callback(response),response.xcallback){let{id:t,title:e}=response.xcallback;aH.context.APP.dialogFactory.createCallback({id:t,message:response.message,title:e,xcallback:response.xcallback,actionHandler:aH})}else{if(response.close_window){let t=aH.context.parent.actionHandler;aH.context.void=!0,aH.context.value[constants.URL_PARAM_ACTION_NAME]===aH.context.static.actorData.insert_action&&t.context.static.actorData&&aH.context.static.actorData.id!==t.context.static.actorData.id&&t.refreshDelayedValue(aH.context.static.actorData.id),aH.context.dataContext.root.forceClose(),aH=t}if(response.eval_js&&eval(response.eval_js),response.record_deleted&&response.success)return aH.context.APP.toast.show({severity:"success",summary:this.ex.i18n.t("Success"),detail:response.message||this.ex.i18n.t("Record Deleted")}),void(aH.context.contextType===constants.CONTEXT_TYPE_SINGLE_ROW?aH.context.APP.navigate(-1):aH.context.contextType===constants.CONTEXT_TYPE_MULTI_ROW&&(await aH.context.history.replace({[constants.URL_PARAM_SELECTED]:[]}),aH.refresh()));if(response.success&&"/"===response.goto_url&&response.close_window)aH.context.APP.reset("sign_in"===response[constants.URL_PARAM_ACTION_NAME]);else{if(response.goto_url){let t=response.goto_url;response.goto_url.includes("#")&&(t=t.split("#")[1]);let[e,s]=t.split("?");void 0===s&&(s=""),aH.context.history.pushPath({pathname:e,params:aH.parser.parseShallow(s)})}response.open_url&&window.open(response.open_url),response.message&&(aH.context.APP.toast.show({severity:response.alert?response.alert.toLowerCase():response.success?"success":"info",summary:response.alert||(response.success?this.ex.i18n.t("Success"):this.ex.i18n.t("Info")),detail:response.message}),aH.context.APP.data.user_state_change&&(delete aH.context.APP.data.user_state_change,aH.context.APP.reset())),response.clear_site_cache?this.context.APP.reload():((response.refresh||response.refresh_all)&&(aH.context.APP.dashboard?aH.context.APP.dashboard.reloadData():aH.reload(),Object.values(aH.context.APP.URLContext.actionHandler.reloadables).forEach((t=>t.reload()))),(response.refresh_delayed_value||response.refresh_all)&&this.refreshDelayedValue(response.refresh_delayed_value),response.hasOwnProperty("editing_mode")&&aH.context.history.replaceState({editing_mode:response.editing_mode}))}}},this.handleAjaxResponse=t=>{this.context.APP.unsetLoadMask();let e=t.status;return e<200?(this.context.APP.toast.show({severity:"warn",summary:this.ex.i18n.t("Unknown response"),detail:this.ex.i18n.t("See for status$t(colonSpaced){{statusCode}}",{statusCode:e})}),{}):e<400?t.json():e<500?(t.text().then((t=>{this.context.APP.toast.show({severity:"error",summary:this.ex.i18n.t("Bad Request"),detail:t})})),t.headers.map["content-type"].startsWith("application/json")?t.json():{success:!1}):(this.context.APP.setServerError(),{success:!1})},this.hasFiles=()=>null!==this.context.dataContext.mutableContext.UploadHandlerEvent,this.load=()=>this.refresh(),this.multiRow=(t={},e=this.context)=>{e.history.pushPath({pathname:`/api/${this.context.value.packId}/${this.context.value.actorId}`,params:Object.assign(this.multiRowParams(this.defaultParams()),t)})},this.parseClone=t=>this.parser.parse(t),this.preprocess=(preprocessor,preprocessedStack={})=>{if(!this.context.filled(preprocessor))return preprocessedStack;preprocessors_1.Lino;let fn=eval(preprocessor),ret;return this.context.filled(fn)&&(ret=fn(this.context,preprocessedStack)),this.context.filled(ret)&&ret instanceof Object&&Object.assign(preprocessedStack,ret),preprocessedStack},this.pvArray=()=>{let t=this.context.dataContext.mutableContext.param_values,e=Object.keys(t);return this.context.static.actorData.params_fields.map((s=>{let a;return a=e.includes(s+"Hidden")?t[s+"Hidden"]:t[s],void 0===a&&(a=null),a}))},this.checkAndRunAction=async t=>{if(["grid","detail","show"].includes(t[constants.URL_PARAM_ACTION_NAME])||!t.clickCatch)return await this.runAction(t);const e=this.cloneState();delete t.clickCatch,e.runnable=t,window.open(`#${this.context.value.path}?${this.parser.stringify({clone:e},!0)}`)},this.findUniqueAction=t=>Object.values(this.context.APP.state.site_data.action_definitions).filter((e=>t===e[constants.URL_PARAM_ACTION_NAME]))[0],this.runAction=async({action_full_name:t,actorId:e,status:s,sr:a=[],rowIndex:i,default_record_id:o,response_callback:n,clickCatch:r=!1,pollContext:c=!1})=>{const{action:l,preprocessedStack:h}=this.getAction(t);let d={action:l,actorId:e,response_callback:n||this.getCallback(l[constants.URL_PARAM_ACTION_NAME]),rowIndex:i,status:s,preprocessedStack:h,pollContext:c};if(s&&s.rqdata&&s.xcallback)return void await this.executeAction(d);this.context.filled(a)?Array.isArray(a)||(a=[a]):a=[],h[constants.URL_PARAM_SELECTED]=a;let _=this.context.static.actorData;if(_&&_.id===e||(_=await this.context.getActorData(e)),h[constants.URL_PARAM_SELECTED].length||(this.context.filled(o)?h[constants.URL_PARAM_SELECTED]=[o]:this.context.filled(_.default_record_id)&&(h[constants.URL_PARAM_SELECTED]=[_.default_record_id])),s&&this.context.pushStatus(s,h,_),l.select_rows&&!h[constants.URL_PARAM_SELECTED].length&&(h[constants.URL_PARAM_SELECTED]=this.context.value[constants.URL_PARAM_SELECTED]),["grid","detail","show"].includes(l[constants.URL_PARAM_ACTION_NAME])){this.context.value.hasActor&&e===this.context.static.actorData.id&&Object.assign(h,{[constants.URL_PARAM_PARAM_VALUES]:this.context.value[constants.URL_PARAM_PARAM_VALUES]}),delete h.callback;let t={pathname:this.URLAppendPKFromSR(`/api/${e.split(".").join("/")}`,h[constants.URL_PARAM_SELECTED]),params:h};this.context.history.pushPath(t,{clickCatch:r})}else l.window_action?this.context.APP.dialogFactory.create(this,d):await this.executeAction(d)},this.singleRow=(t,e,s=this.context,a={})=>{if(this.context.static.actorData.detail_action){if(void 0===e&&(e=t.data[this.context.static.actorData.pk_index]),void 0!==e){let t=this.defaultStaticParams();t[constants.URL_PARAM_PARAM_VALUES]=this.context.value[constants.URL_PARAM_PARAM_VALUES],s.history.pushPath({pathname:`/api/${this.context.value.packId}/${this.context.value.actorId}/${e}`,params:t},a)}}else console.warn(this.context.static.actorData.id+" has no attribute detail_action")},this.stringifyClone=t=>this.parser.stringify(t,!0),this.submit=async({cellInfo:t})=>{let e=constants.DISPLAY_MODE_DETAIL;if(void 0!==t&&(e=t.rowIndex),!this.context.dataContext.isModified(e))return void(t||this.context.APP.toast.show({severity:"info",summary:"N/A",detail:this.ex.i18n.t("No modified data detected.")}));let s=this.context.dataContext,a=this.context.static.actorData,i={action_full_name:"",pollContext:!0,actorId:a.id};if(void 0===t&&s.root.setState({loading:!0}),void 0!==t){let t=s.mutableContext.rows[e][a.pk_index],o=null===t;i.action_full_name=o?a.grid_post:a.update_action,i[constants.URL_PARAM_SELECTED]=o?[]:[t],i.rowIndex=e,i.response_callback=t=>{if(t.master_data&&this.context.isSlave){const e=this.context.parent.dataContext;e.updateState(Object.assign(e.mutableContext.data,t.master_data))}void 0!==t.rows&&(o&&(s.mutableContext.rows.push(s.contextBackup.rows[e]),s.contextBackup.rows.push(this.ex._.cloneDeep(s.contextBackup.rows[e])),s.mutableContext.count+=1,s.contextBackup.count+=1,s.mutableContext.modifiedRows[e+1]=[]),s.mutableContext.rows[e]=t.rows[0],s.contextBackup.rows[e]=this.ex._.cloneDeep(t.rows[0]),s.mutableContext.modifiedRows[e]=[],s.updateState({}))}}else if(this.context.contextType===constants.CONTEXT_TYPE_SINGLE_ROW)i.action_full_name=a.submit_detail,i[constants.URL_PARAM_SELECTED]=this.context.value[constants.URL_PARAM_SELECTED];else{if(this.context.contextType===constants.CONTEXT_TYPE_TEXT_FIELD)return void this.XHRPutPost({path:this.context.value.path.slice(1),body:Object.assign(this.commonParams(),{[constants.URL_PARAM_ACTION_NAME]:"submit_detail"},s.mutableContext.data),response_callback:t=>{t.success&&(s.contextBackup.data=this.ex._.cloneDeep(s.mutableContext.data),s.mutableContext.modified=[])}},"PUT");if(this.context.contextType!==constants.CONTEXT_TYPE_ACTION)throw Error("Unknown client state");i.action_full_name=a.submit_insert,i.response_callback=t=>{}}this.runAction(i)},this.submitDetailCallback=t=>{let e=this.context.dataContext;t.success&&(e.backupContext(t.data_record),e.mutableContext.modified=[],e.updateState(t.data_record),Object.values(e.refStore.virtualLeaves).forEach((t=>t.setState({key:this.context.newSlug().toString()})))),e.root.setState({loading:!1}),this.context.history.replaceState({editing_mode:!1}),"users.Me"===this.context.static.actorData.id&&this.context.APP.reset(!0)},this.submitFiles=t=>{let e=this.context.dataContext.mutableContext.UploadHandlerEvent;if(this.context.filled(e)){const s=new XMLHttpRequest,a=new FormData,{files:i,options:o}=e;Object.values(i).forEach((t=>{a.append(o.props.name,t,t.name)})),Object.keys(t).forEach((e=>{if(this.context.filled(t[e])){let s=t[e];Array.isArray(s)?s.forEach((t=>a.append(e,t))):a.append(e,s)}})),s.onreadystatechange=async()=>{4===s.readyState&&s.status>=200&&s.status<300?(this.context.dataContext.mutableContext.UploadHandlerEvent=null,await this.handleActionResponse({response:JSON.parse(s.responseText)})):413==s.status?this.context.APP.toast.show({severity:"error",summary:this.ex.i18n.t("Bad request"),detail:this.ex.i18n.t("File is too large! it exceeds the server upload limit")}):this.context.APP.toast.show({severity:"error",summary:this.ex.i18n.t("Bad request"),detail:s.responseText})},s.open("POST",o.props.url,!0),s.withCredentials=o.props.withCredentials,s.send(a)}},this.update=({values:t,elem:e,col:s,windowType:a=constants.WINDOW_TYPE_DETAIL})=>{let i=this.context.dataContext;if(a===constants.WINDOW_TYPE_PARAMS)Object.assign(i.mutableContext.param_values,t),this.context.history.replace({[constants.URL_PARAM_PARAM_VALUES]:this.pvArray()});else if(this.context.contextType===constants.CONTEXT_TYPE_MULTI_ROW){let a=i.mutableContext.modifiedRows[s.rowIndex].indexOf(e.fields_index),o=Object.values(t)[0]===i.contextBackup.rows[s.rowIndex][e.fields_index];a<0&&!o?i.mutableContext.modifiedRows[s.rowIndex].push(e.fields_index):a>-1&&o&&i.mutableContext.modifiedRows[s.rowIndex].splice(a,1),Object.assign(i.mutableContext.rows[s.rowIndex],t)}else{let s=i.mutableContext.modified.indexOf(e.name);s<0?i.contextBackup.data[e.name]!==Object.values(t)[0]&&i.mutableContext.modified.push(e.name):i.contextBackup.data[e.name]===Object.values(t)[0]&&i.mutableContext.modified.splice(s,1),Object.assign(i.mutableContext.data,t)}},this.XHRPutPost=async({path:t,body:e,signal:s,silent:a=!1,response_callback:i},o)=>{a||this.context.APP.setLoadMask(),this.ex.fetchPolyfill(t,{method:o,body:new URLSearchParams(this.ex.queryString.default.stringify(e)),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"},signal:s}).then(this.handleAjaxResponse).then((async t=>{await this.handleActionResponse({response:t,response_callback:i})}))}}async prepare(){this.ex.weakKey=this.ex.weakKey.default,this.ex._=this.ex._.default,this.ex.i18n=this.ex.i18n.default,this.ex.AbortController=this.ex.AbortController.default,this.ex.fetchPolyfill=this.ex.whatwgFetch.fetch,this.abortController=new this.ex.AbortController}onReady({context:t,next:e}){this.context=t,this.refName=this.ex.weakKey(this),t.APP.rps[this.refName]=this,this.reloadables={},this.cloneState=this.cloneState.bind(this),this.clearMod=this.clearMod.bind(this),this.copyData=this.copyData.bind(this),this.defaultParams=this.defaultParams.bind(this),this.defaultStaticParams=this.defaultStaticParams.bind(this),this.discardModDConfirm=this.discardModDConfirm.bind(this),this.executeAction=this.executeAction.bind(this),this.fetch=this.fetch.bind(this),this.getAction=this.getAction.bind(this),this.getCallback=this.getCallback.bind(this),this.getParams=this.getParams.bind(this),this.getPath=this.getPath.bind(this),this.handledFetch=this.handledFetch.bind(this),this.handleActionResponse=this.handleActionResponse.bind(this),this.handleAjaxResponse=this.handleAjaxResponse.bind(this),this.load=this.load.bind(this),this.multiRowParams=this.multiRowParams.bind(this),this.refresh=this.refresh.bind(this),this.reload=this.reload.bind(this),this.silentFetch=this.silentFetch.bind(this),this.submit=this.submit.bind(this),this.submitDetailCallback=this.submitDetailCallback.bind(this),this.submitFiles=this.submitFiles.bind(this),this.update=this.update.bind(this),this.parser=new URLParser({next:()=>e(this)})}}exports.ActionHandler=ActionHandler,ActionHandler.requiredModules=["u","weakKey","_","whatwgFetch","AbortController","queryString","i18n"],ActionHandler.iPool=exModulePromises},8267:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Lino=void 0;let s=window.Lino||{};e.Lino=s,s.get_current_grid_config=(t,e)=>(t.dataContext.root.get_current_grid_config(e),e),s.captureImage=(t,e)=>(e.callback={callback:s=>{t.APP.dialogFactory.createWebcamDialog(t,e,s)},callbackType:"postWindowInit"},e)},936:(t,e,s)=>{s.d(e,{A:()=>c});const a="%[a-f0-9]{2}",i=new RegExp("("+a+")|([^%]+?)","gi"),o=new RegExp("("+a+")+","gi");function n(t,e){try{return[decodeURIComponent(t.join(""))]}catch{}if(1===t.length)return t;e=e||1;const s=t.slice(0,e),a=t.slice(e);return Array.prototype.concat.call([],n(s),n(a))}function r(t){try{return decodeURIComponent(t)}catch{let e=t.match(i)||[];for(let s=1;s<e.length;s++)e=(t=n(e,s).join("")).match(i)||[];return t}}function c(t){if("string"!=typeof t)throw new TypeError("Expected `encodedURI` to be of type `string`, got `"+typeof t+"`");try{return decodeURIComponent(t)}catch{return function(t){const e={"%FE%FF":"��","%FF%FE":"��"};let s=o.exec(t);for(;s;){try{e[s[0]]=decodeURIComponent(s[0])}catch{const t=r(s[0]);t!==s[0]&&(e[s[0]]=t)}s=o.exec(t)}e["%C2"]="�";const a=Object.keys(e);for(const s of a)t=t.replace(new RegExp(s,"g"),e[s]);return t}(t)}}},7157:(t,e,s)=>{function a(t,e){const s={};if(Array.isArray(e))for(const a of e){const e=Object.getOwnPropertyDescriptor(t,a);e?.enumerable&&Object.defineProperty(s,a,e)}else for(const a of Reflect.ownKeys(t)){const i=Object.getOwnPropertyDescriptor(t,a);if(i.enumerable){e(a,t[a],t)&&Object.defineProperty(s,a,i)}}return s}s.d(e,{b:()=>a})},9274:(t,e,s)=>{function a(t,e){if("string"!=typeof t||"string"!=typeof e)throw new TypeError("Expected the arguments to be of type `string`");if(""===t||""===e)return[];const s=t.indexOf(e);return-1===s?[]:[t.slice(0,s),t.slice(s+e.length)]}s.d(e,{A:()=>a})}}]);
//# sourceMappingURL=main.NavigationControl_App.c441f8b359d8f9b77126.js.map