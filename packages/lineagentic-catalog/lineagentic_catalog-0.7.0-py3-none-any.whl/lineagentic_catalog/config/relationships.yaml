# Aspect-Driven Relationship Rules
# This file contains relationship rule definitions for automatic relationship creation

# Aspect-Driven Relationship Rules
aspect_relationships:
  ownership:
    description: "Creates OWNS relationships from ownership aspect data"
    rules:
      - entity_type: "Dataset"
        relationship_type: "OWNS"
        source_entity: "CorpUser"
        target_entity: "Dataset"
        direction: "incoming"
        field_mapping:
          source_field: "owners[].owner"
          source_entity_type: "CorpUser"
          source_urn_field: "username"
          target_entity_type: "Dataset"
          target_urn_field: "urn"
      - entity_type: "DataJob"
        relationship_type: "OWNS"
        source_entity: "CorpUser"
        target_entity: "DataJob"
        direction: "incoming"
        field_mapping:
          source_field: "owners[].owner"
          source_entity_type: "CorpUser"
          source_urn_field: "username"
          target_entity_type: "DataJob"
          target_urn_field: "urn"

  globalTags:
    description: "Creates TAGGED relationships from globalTags aspect data"
    rules:
      - entity_type: "Dataset"
        relationship_type: "TAGGED"
        source_entity: "Dataset"
        target_entity: "Tag"
        direction: "outgoing"
        field_mapping:
          source_field: "tags[].tag"
          source_entity_type: "Dataset"
          source_urn_field: "urn"
          target_entity_type: "Tag"
          target_urn_field: "key"

  transformation:
    description: "Creates DERIVES_FROM, TRANSFORMS and UPSTREAM_OF relationships from transformation aspect data"
    rules:
      - entity_type: "Column"
        relationship_type: "DERIVES_FROM"
        source_entity: "Column"
        target_entity: "Column"
        direction: "outgoing"
        field_mapping:
          source_field: "inputColumns[]"
          source_entity_type: "Column"
          source_urn_field: "urn"
          target_entity_type: "Column"
          target_urn_field: "urn"
          source_urn_template: "{sourceDataset}#{source_field}"
          target_urn_template: "{targetDataset}#{field_path}"
      - entity_type: "Column"
        relationship_type: "TRANSFORMS"
        source_entity: "Column"
        target_entity: "Column"
        direction: "incoming"
        field_mapping:
          source_field: "inputColumns[]"
          source_entity_type: "Column"
          source_urn_field: "urn"
          target_entity_type: "Column"
          target_urn_field: "urn"
          source_urn_template: "{sourceDataset}#{source_field}"
          target_urn_template: "{targetDataset}#{field_path}"
        additional_relationships:
          - relationship_type: "UPSTREAM_OF"
            source_entity: "Dataset"
            target_entity: "Dataset"
            direction: "outgoing"
            field_mapping:
              source_field: "sourceDataset"
              target_field: "targetDataset"

  schemaMetadata:
    description: "Creates HAS_COLUMN relationships from schemaMetadata aspect data"
    rules:
      - entity_type: "Dataset"
        relationship_type: "HAS_COLUMN"
        source_entity: "Dataset"
        target_entity: "Column"
        direction: "outgoing"
        field_mapping:
          source_field: "fields[].fieldPath"
          source_entity_type: "Dataset"
          source_urn_field: "urn"
          target_entity_type: "Column"
          target_urn_field: "urn"
          target_urn_template: "{source_urn}#{source_field}"

  dataJobInputOutput:
    description: "Creates CONSUMES and PRODUCES relationships from dataJobInputOutput aspect data"
    rules:
      - entity_type: "DataJob"
        relationship_type: "CONSUMES"
        source_entity: "DataJob"
        target_entity: "Dataset"
        direction: "outgoing"
        field_mapping:
          source_field: "inputs[]"
          source_entity_type: "DataJob"
          source_urn_field: "urn"
          target_entity_type: "Dataset"
          target_urn_field: "urn"
      - entity_type: "DataJob"
        relationship_type: "PRODUCES"
        source_entity: "DataJob"
        target_entity: "Dataset"
        direction: "outgoing"
        field_mapping:
          source_field: "outputs[]"
          source_entity_type: "DataJob"
          source_urn_field: "urn"
          target_entity_type: "Dataset"
          target_urn_field: "urn"

  dataFlowInfo:
    description: "Creates HAS_JOB relationships from dataFlowInfo aspect data"
    rules:
      - entity_type: "DataFlow"
        relationship_type: "HAS_JOB"
        source_entity: "DataFlow"
        target_entity: "DataJob"
        direction: "outgoing"
        field_mapping:
          source_field: "jobs[]"
          source_entity_type: "DataFlow"
          source_urn_field: "urn"
          target_entity_type: "DataJob"
          target_urn_field: "urn"
          target_urn_template: "{source_urn}#{source_field}"
