"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([["95164"],{99153:function(t,e,s){s.a(t,async function(t,a){try{s.r(e),s.d(e,{HuiEnergyDevicesDetailGraphCard:function(){return w}});s(26847),s(2394),s(44438),s(18574),s(81738),s(94814),s(29981),s(22960),s(6989),s(93190),s(87799),s(64455),s(6202),s(27530);var o=s(73742),i=s(66386),n=s(26062),r=s(59048),c=s(7616),d=s(31733),h=s(28105),_=s(55815),p=s(94412),u=(s(31138),s(37008)),l=s(6640),m=s(7214),f=s(6291),v=s(93647),g=s(94969),y=s(9924),S=s(28598),b=t([u,l,S,g]);[u,l,S,g]=b.then?(await b)():b;let k,C,$,D=t=>t;const E="kWh";class w extends((0,f.f)(r.oi)){hassSubscribe(){var t;return[(0,l.UB)(this.hass,{key:null===(t=this._config)||void 0===t?void 0:t.collection_key}).subscribe(t=>{this._data=t})]}getCardSize(){return 3}setConfig(t){this._config=t}shouldUpdate(t){return(0,v.SN)(this,t)||t.size>1||!t.has("hass")}willUpdate(t){(t.has("_config")||t.has("_data"))&&this._processStatistics()}render(){return this.hass&&this._config?(0,r.dy)(k||(k=D` <ha-card> ${0} <div class="content ${0}"> <ha-chart-base .hass="${0}" .data="${0}" .options="${0}" @dataset-hidden="${0}" @dataset-unhidden="${0}"></ha-chart-base> </div> </ha-card> `),this._config.title?(0,r.dy)(C||(C=D`<h1 class="card-header">${0}</h1>`),this._config.title):"",(0,d.$)({"has-header":!!this._config.title}),this.hass,this._chartData,this._createOptions(this._start,this._end,this.hass.locale,this.hass.config,E,this._compareStart,this._compareEnd),this._datasetHidden,this._datasetUnhidden):r.Ld}_datasetHidden(t){this._hiddenStats=[...this._hiddenStats,t.detail.id]}_datasetUnhidden(t){this._hiddenStats=this._hiddenStats.filter(e=>e!==t.detail.id)}_processStatistics(){if(!this._data)return;const t=this._data;this._start=t.start,this._end=t.end||(0,i.p)(),this._compareStart=t.startCompare,this._compareEnd=t.endCompare;const e=t.stats,s=t.statsCompare,a=getComputedStyle(this),o=t.prefs.device_consumption,n={};o.forEach(t=>{t.included_in_stat&&(n[t.included_in_stat]=n[t.included_in_stat]||[],n[t.included_in_stat].push(t.stat_consumption))});const r={};t.prefs.device_consumption.forEach(t=>{const s=t.stat_consumption in e&&(0,m.Kj)(e[t.stat_consumption])||0;r[t.stat_consumption]=s});const c={};t.prefs.device_consumption.forEach(t=>{c[t.stat_consumption]=(n[t.stat_consumption]||[]).reduce((t,e)=>t-r[e],r[t.stat_consumption])});const d=t.prefs.device_consumption.map(t=>t.stat_consumption);d.sort((t,e)=>c[e]-c[t]);const h=[],{summedData:_,compareSummedData:p}=(0,l.EH)(t),u="from_grid"in _||"solar"in _||"from_battery"in _,{consumption:f,compareConsumption:v}=u?(0,l.E4)(_,p):{consumption:void 0,compareConsumption:void 0};if(s){const e=this._processDataSet(a,s,t.statsMetadata,t.prefs.device_consumption,d,n,!0);if(h.push(...e),u){const t=this._processUntracked(a,e,v,!0);h.push(t)}}h.push({id:"compare-placeholder",type:"bar",stack:t.statsCompare?"devicesCompare":"devices",data:[]});const y=this._processDataSet(a,e,t.statsMetadata,t.prefs.device_consumption,d,n);if(h.push(...y),this._legendData=y.map(t=>{var e;return{id:t.id,name:t.name,itemStyle:{color:t.color,borderColor:null===(e=t.itemStyle)||void 0===e?void 0:e.borderColor}}}),u){var S;const t=this._processUntracked(a,y,f,!1);h.push(t),this._legendData.push({id:t.id,name:t.name,itemStyle:{color:t.color,borderColor:null===(S=t.itemStyle)||void 0===S?void 0:S.borderColor}})}(0,g.Zx)(h),this._chartData=h}_processUntracked(t,e,s,a){const o={};e.forEach(t=>{t.data.forEach(t=>{o[t[a?2:0]]=(o[t[a?2:0]]||0)+t[1]})});const i=(0,g.kT)(this._start,this._compareStart),n=[];Object.keys(s.used_total).sort((t,e)=>Number(t)-Number(e)).forEach(t=>{const e=Number(t),r=[e,s.used_total[t]-(o[t]||0)];a&&(r[2]=r[0],r[0]=i(new Date(e)).getTime()),n.push(r)});const r=Date.now();return{type:"bar",cursor:"default",id:a?`compare-untracked-${r}`:`untracked-${r}`,name:this.hass.localize("ui.panel.lovelace.cards.energy.energy_devices_detail_graph.untracked_consumption"),itemStyle:{borderColor:(0,p.H)(t,this.hass.themes.darkMode,!1,a,"--history-unknown-color")},barMaxWidth:50,color:(0,p.H)(t,this.hass.themes.darkMode,!0,a,"--history-unknown-color"),data:n,stack:a?"devicesCompare":"devices"}}_processDataSet(t,e,s,a,o,i,n=!1){const r=[],c=(0,g.kT)(this._start,this._compareStart);return a.forEach((a,d)=>{var h;const p=o.indexOf(a.stat_consumption);if(null!==(h=this._config)&&void 0!==h&&h.max_devices&&p>=this._config.max_devices)return void console.warn(`Max devices exceeded for ${a.name} (${p} >= ${this._config.max_devices})`);const u=(0,_.hZ)(d,t);let l=null;const f=[];if(a.stat_consumption in e){const t=e[a.stat_consumption];for(const s of t){if(null===s.change||void 0===s.change||0===s.change)continue;if(l===s.start)continue;let t=0;(i[a.stat_consumption]||[]).forEach(a=>{var o;const i=e[a];t+=(null==i||null===(o=i.find(t=>t.start===s.start))||void 0===o?void 0:o.change)||0});const o=[s.start,s.change-t];n&&(o[2]=o[0],o[0]=c(new Date(s.start)).getTime()),f.push(o),l=s.start}}const v=(a.name||(0,m.Kd)(this.hass,a.stat_consumption,s[a.stat_consumption]))+(a.stat_consumption in i?` (${this.hass.localize("ui.panel.lovelace.cards.energy.energy_devices_detail_graph.untracked")})`:"");r.push({type:"bar",cursor:"default",id:n?`compare-${a.stat_consumption}-${p}`:`${a.stat_consumption}-${p}`,name:v,itemStyle:{borderColor:n?u+"7F":u},barMaxWidth:50,color:n?u+"32":u+"7F",data:f,stack:n?"devicesCompare":"devices"})}),o.map(t=>r.find(e=>this._getStatIdFromId(e.id)===t)).filter(Boolean)}_getStatIdFromId(t){return t.replace(/^compare-/,"").replace(/-\d+$/,"")}constructor(...t){super(...t),this._chartData=[],this._start=(0,n.I)(),this._end=(0,i.p)(),this._hiddenStats=[],this.hassSubscribeRequiredHostProps=["_config"],this._formatTotal=t=>this.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.total_consumed",{num:(0,S.uf)(t,this.hass.locale),unit:E}),this._createOptions=(0,h.Z)((t,e,s,a,o,i,n)=>{const r=(0,g.J)(t,e,s,a,o,i,n,this._formatTotal);return Object.assign(Object.assign({},r),{},{legend:{show:!0,type:"custom",data:this._legendData,selected:this._hiddenStats.reduce((t,e)=>(t[e]=!1,t),{})},grid:{top:15,bottom:0,left:1,right:1,containLabel:!0}})})}}w.styles=(0,r.iv)($||($=D`.card-header{padding-bottom:0}.content{padding:16px}.has-header{padding-top:0}`)),(0,o.__decorate)([(0,c.Cb)({attribute:!1})],w.prototype,"hass",void 0),(0,o.__decorate)([(0,c.SB)()],w.prototype,"_config",void 0),(0,o.__decorate)([(0,c.SB)()],w.prototype,"_chartData",void 0),(0,o.__decorate)([(0,c.SB)()],w.prototype,"_data",void 0),(0,o.__decorate)([(0,c.SB)()],w.prototype,"_legendData",void 0),(0,o.__decorate)([(0,c.SB)()],w.prototype,"_start",void 0),(0,o.__decorate)([(0,c.SB)()],w.prototype,"_end",void 0),(0,o.__decorate)([(0,c.SB)()],w.prototype,"_compareStart",void 0),(0,o.__decorate)([(0,c.SB)()],w.prototype,"_compareEnd",void 0),(0,o.__decorate)([(0,c.SB)(),(0,y.t)({key:"energy-devices-hidden-stats",state:!0,subscribe:!1})],w.prototype,"_hiddenStats",void 0),w=(0,o.__decorate)([(0,c.Mo)("hui-energy-devices-detail-graph-card")],w),a()}catch(k){a(k)}})}}]);
//# sourceMappingURL=95164.8564a6816eceb3da.js.map