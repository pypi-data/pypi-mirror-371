<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qalita CLI UI - {{ title }}</title>
  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="/static/styles.css" />
</head>

<body style="background-repeat: no-repeat;">
  <div class="topbar">
    <div class="brand">
      <div class="left">
        <img src="/static/logo-no-slogan.png" alt="Qalita" />
        <span>Qalita CLI UI</span>
      </div>
      <div class="right"><a href="https://doc.qalita.io/" target="_blank" rel="noopener noreferrer">Help</a></div>
    </div>
  </div>
  <div class="container-form">
    <h1>{{ title }}</h1>
    <div class="card">
      {% if error %}
      <div class="alert alert-error">{{ error }}</div>
      {% endif %}
      <form method="post">
        <label>Name
          <input type="text" name="name" value="{{ (source.name if source) or '' }}" required />
        </label>
        <label>Description
          <input type="text" name="description" value="{{ (source.description if source) or '' }}" />
        </label>

        <label>Type
          <div class="type-field">
            <img id="edit_type_icon" class="type-icon" src="/static/sources-logos/folder.svg" alt="type" />
            <select name="type" id="edit_type" required>
              {% for t in
              ['file','folder','postgresql','mysql','oracle','mssql','sqlite','mongodb','s3','gcs','azure_blob','hdfs','sftp','http','https']
              %}
              <option value="{{t}}" {% if source and source.type==t %}selected{% endif %}>{{t}}</option>
              {% endfor %}
            </select>
          </div>
        </label>

        <!-- Dynamic fields by type -->
        <div id="edit_fields_file" class="edit-type-fields hidden">
          <label>File path
            <div class="row" style="grid-template-columns: 1fr auto; align-items: end;">
              <input type="text" id="file_path" name="file_path" style="width: 100%;"
                value="{{ (source.config.path if source and source.config) or '' }}" />
              <button class="btn secondary" type="button" id="btn_browse_file">Browse…</button>
            </div>
          </label>
        </div>

        <div id="edit_fields_folder" class="edit-type-fields hidden">
          <label>Folder path
            <div class="row" style="grid-template-columns: 1fr auto; align-items: end;">
              <input type="text" id="folder_path" name="folder_path"
                value="{{ (source.config.path if source and source.config) or '' }}" />
              <button class="btn secondary" type="button" id="btn_browse_folder">Browse…</button>
            </div>
          </label>
        </div>

        <div id="edit_fields_sqlite" class="edit-type-fields hidden">
          <label>SQLite file path
            <input type="text" name="sqlite_file_path"
              value="{{ (source.config.file_path if source and source.config) or '' }}" />
          </label>
        </div>

        <div id="edit_fields_db" class="edit-type-fields hidden">
          <div class="row">
            <div>
              <label>Host<input type="text" name="db_host"
                  value="{{ (source.config.host if source and source.config) or '' }}" /></label>
            </div>
            <div>
              <label>Port<input type="number" name="db_port"
                  value="{{ (source.config.port if source and source.config) or '' }}" /></label>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Username<input type="text" name="db_username"
                  value="{{ (source.config.username if source and source.config) or '' }}" /></label>
            </div>
            <div>
              <label>Password<input type="password" name="db_password"
                  value="{{ (source.config.password if source and source.config) or '' }}" /></label>
            </div>
          </div>
          <label>Database
            <input type="text" name="db_database"
              value="{{ (source.config.database if source and source.config) or '' }}" />
          </label>
          <label>Tables or SQL (default '*')
            <input type="text" name="db_table_or_query"
              value="{{ (source.config.table_or_query if source and source.config) or '*' }}" />
          </label>
        </div>

        <div id="edit_fields_mongodb" class="edit-type-fields hidden">
          <div class="row">
            <div>
              <label>Host<input type="text" name="mongo_host"
                  value="{{ (source.config.host if source and source.config) or '' }}" /></label>
            </div>
            <div>
              <label>Port<input type="number" name="mongo_port"
                  value="{{ (source.config.port if source and source.config) or '' }}" /></label>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Username<input type="text" name="mongo_username"
                  value="{{ (source.config.username if source and source.config) or '' }}" /></label>
            </div>
            <div>
              <label>Password<input type="password" name="mongo_password"
                  value="{{ (source.config.password if source and source.config) or '' }}" /></label>
            </div>
          </div>
          <label>Database<input type="text" name="mongo_database"
              value="{{ (source.config.database if source and source.config) or '' }}" /></label>
        </div>

        <div id="edit_fields_s3" class="edit-type-fields hidden">
          <label>Bucket<input type="text" name="s3_bucket"
              value="{{ (source.config.bucket if source and source.config) or '' }}" /></label>
          <label>Prefix<input type="text" name="s3_prefix"
              value="{{ (source.config.prefix if source and source.config) or '' }}" /></label>
          <div class="row">
            <div><label>Access key<input type="text" name="s3_access_key"
                  value="{{ (source.config.access_key if source and source.config) or '' }}" /></label></div>
            <div><label>Secret key<input type="password" name="s3_secret_key"
                  value="{{ (source.config.secret_key if source and source.config) or '' }}" /></label></div>
          </div>
          <label>Region<input type="text" name="s3_region"
              value="{{ (source.config.region if source and source.config) or '' }}" /></label>
        </div>

        <div id="edit_fields_gcs" class="edit-type-fields hidden">
          <label>Bucket<input type="text" name="gcs_bucket"
              value="{{ (source.config.bucket if source and source.config) or '' }}" /></label>
          <label>Prefix<input type="text" name="gcs_prefix"
              value="{{ (source.config.prefix if source and source.config) or '' }}" /></label>
          <label>Credentials JSON path<input type="text" name="gcs_credentials"
              value="{{ (source.config.credentials_json if source and source.config) or '' }}" /></label>
        </div>

        <div id="edit_fields_azure" class="edit-type-fields hidden">
          <label>Container<input type="text" name="az_container"
              value="{{ (source.config.container if source and source.config) or '' }}" /></label>
          <label>Prefix<input type="text" name="az_prefix"
              value="{{ (source.config.prefix if source and source.config) or '' }}" /></label>
          <label>Connection string<input type="password" name="az_connection"
              value="{{ (source.config.connection_string if source and source.config) or '' }}" /></label>
        </div>

        <div id="edit_fields_hdfs" class="edit-type-fields hidden">
          <label>Namenode host<input type="text" name="hdfs_namenode"
              value="{{ (source.config.namenode_host if source and source.config) or '' }}" /></label>
          <label>Port<input type="number" name="hdfs_port"
              value="{{ (source.config.port if source and source.config) or '' }}" /></label>
          <label>User<input type="text" name="hdfs_user"
              value="{{ (source.config.user if source and source.config) or '' }}" /></label>
          <label>Path<input type="text" name="hdfs_path"
              value="{{ (source.config.path if source and source.config) or '' }}" /></label>
        </div>

        <div id="edit_fields_sftp" class="edit-type-fields hidden">
          <label>Host<input type="text" name="sftp_host"
              value="{{ (source.config.host if source and source.config) or '' }}" /></label>
          <label>Port<input type="number" name="sftp_port"
              value="{{ (source.config.port if source and source.config) or '' }}" /></label>
          <label>Username<input type="text" name="sftp_username"
              value="{{ (source.config.username if source and source.config) or '' }}" /></label>
          <label>Password<input type="password" name="sftp_password"
              value="{{ (source.config.password if source and source.config) or '' }}" /></label>
          <label>Path<input type="text" name="sftp_path"
              value="{{ (source.config.path if source and source.config) or '' }}" /></label>
        </div>

        <div id="edit_fields_http" class="edit-type-fields hidden">
          <label>URL<input type="text" name="http_url"
              value="{{ (source.config.url if source and source.config) or '' }}" /></label>
          <label>Auth type
            <select name="http_auth_type" id="edit_http_auth_type">
              {% set at = (source.config.auth_type if source and source.config) or 'none' %}
              <option value="none" {% if at=='none' %}selected{% endif %}>none</option>
              <option value="basic" {% if at=='basic' %}selected{% endif %}>basic</option>
              <option value="token" {% if at=='token' %}selected{% endif %}>token</option>
            </select>
          </label>
          <div id="edit_fields_http_basic" class="hidden">
            <label>Username<input type="text" name="http_username"
                value="{{ (source.config.username if source and source.config) or '' }}" /></label>
            <label>Password<input type="password" name="http_password"
                value="{{ (source.config.password if source and source.config) or '' }}" /></label>
          </div>
          <div id="edit_fields_http_token" class="hidden">
            <label>Token<input type="password" name="http_token"
                value="{{ (source.config.token if source and source.config) or '' }}" /></label>
          </div>
        </div>

        <div class="row" style="margin-bottom:12px;">
          <div>
            <label>Visibility
              <div class="vis-field">
                <span id="vis_icon" class="vis-icon" aria-hidden="true"></span>
                <select name="visibility" id="edit_visibility">
                  {% for v in ['private','internal','public'] %}
                  <option value="{{v}}" {% if source and source.visibility==v %}selected{% endif %}>{{v}}</option>
                  {% endfor %}
                </select>
              </div>
            </label>
          </div>
          <div>
            <label><input type="checkbox" name="reference" {% if source and source.reference %}checked{% endif %} />
              Reference</label>
            <label><input type="checkbox" name="sensitive" {% if source and source.sensitive %}checked{% endif %} />
              Sensitive</label>
          </div>
        </div>

        <div class="actions">
          <button class="btn" type="submit">Save</button>
          <a class="btn secondary" href="/">Cancel</a>
        </div>
      </form>
    </div>
  </div>

  <script>
    const tSel = document.getElementById('edit_type');
    const vSel = document.getElementById('edit_visibility');
    const ICONS = {
      file: 'file.svg', folder: 'folder.svg', postgresql: 'postgresql.svg', mysql: 'mysql.svg', oracle: 'oracle.svg', mssql: 'mssql.svg', sqlite: 'sqlite.svg', mongodb: 'mongodb.svg', s3: 's3.svg', gcs: 'gcs.png', azure_blob: 'azure_blob.svg', hdfs: 'hdfs.svg', sftp: 'sftp.svg', http: 'http.svg', https: 'https.svg'
    };
    function show(id, v) { const el = document.getElementById(id); if (el) { el.classList.toggle('hidden', !v); } }
    function updateTypeIcon() {
      const t = tSel ? tSel.value : 'folder';
      const file = ICONS[t] || 'folder.svg';
      const el = document.getElementById('edit_type_icon');
      if (el) { el.setAttribute('src', '/static/sources-logos/' + file); el.setAttribute('alt', t); }
    }
    function visibilityIconHTML(v) {
      v = (v || '').toLowerCase();
      if (v === 'private') return "<svg width='16' height='16' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'><rect x='3' y='9' width='14' height='8' rx='2' stroke='#374151' stroke-width='2'/><path d='M6 9V7a4 4 0 1 1 8 0v2' stroke='#374151' stroke-width='2' fill='none'/></svg>";
      if (v === 'internal') return "<svg width='16' height='16' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'><rect x='3' y='6' width='14' height='10' rx='2' stroke='#0ea5e9' stroke-width='2'/><path d='M7 6V4h6v2' stroke='#0ea5e9' stroke-width='2'/></svg>";
      if (v === 'public') return "<svg width='16' height='16' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'><circle cx='10' cy='10' r='8' stroke='#16a34a' stroke-width='2'/><path d='M2 10h16M10 2a12 12 0 0 1 0 16M10 2a12 12 0 0 0 0 16' stroke='#16a34a' stroke-width='2'/></svg>";
      return '';
    }
    function updateVisIcon() {
      const el = document.getElementById('vis_icon');
      if (!el) return;
      el.innerHTML = visibilityIconHTML(vSel ? vSel.value : 'private');
    }
    function updateTypeFields() {
      const t = tSel ? tSel.value : 'file';
      ['edit_fields_file', 'edit_fields_folder', 'edit_fields_sqlite', 'edit_fields_db', 'edit_fields_mongodb', 'edit_fields_s3', 'edit_fields_gcs', 'edit_fields_azure', 'edit_fields_hdfs', 'edit_fields_sftp', 'edit_fields_http'].forEach(id => show(id, false));
      if (t === 'file') show('edit_fields_file', true);
      if (t === 'folder') show('edit_fields_folder', true);
      if (['mysql', 'postgresql', 'oracle', 'mssql'].includes(t)) show('edit_fields_db', true);
      if (t === 'sqlite') show('edit_fields_sqlite', true);
      if (t === 'mongodb') show('edit_fields_mongodb', true);
      if (t === 's3') show('edit_fields_s3', true);
      if (t === 'gcs') show('edit_fields_gcs', true);
      if (t === 'azure_blob') show('edit_fields_azure', true);
      if (t === 'hdfs') show('edit_fields_hdfs', true);
      if (t === 'sftp') show('edit_fields_sftp', true);
      if (t === 'http' || t === 'https') show('edit_fields_http', true);
    }
    if (tSel) {
      tSel.addEventListener('change', updateTypeIcon);
      tSel.addEventListener('change', updateTypeFields);
    }
    if (vSel) { vSel.addEventListener('change', updateVisIcon); }
    // Initialize on DOMContentLoaded to ensure elements exist
    document.addEventListener('DOMContentLoaded', function () {
      updateTypeIcon();
      updateVisIcon();
      updateTypeFields();

      const browseFile = document.getElementById('btn_browse_file');
      const browseFolder = document.getElementById('btn_browse_folder');
      if (browseFile) {
        browseFile.addEventListener('click', async () => {
          try {
            const res = await fetch('/sources/pick-file');
            const data = await res.json();
            if (data.path) {
              const fp = document.getElementById('file_path');
              if (fp) fp.value = data.path;
            }
          } catch (e) { /* ignore */ }
        });
      }
      if (browseFolder) {
        browseFolder.addEventListener('click', async () => {
          try {
            const res = await fetch('/sources/pick-folder');
            const data = await res.json();
            if (data.path) {
              const dp = document.getElementById('folder_path');
              if (dp) dp.value = data.path;
            }
          } catch (e) { /* ignore */ }
        });
      }
    });
  </script>
  <div class="footer">
    <div class="inner">
      <div>
        <span>&copy; QALITA</span> — Qalita CLI UI
      </div>
      <div>
        <span id="cli_version"></span>
        &nbsp;•&nbsp;
        <a href="https://qalita.io" target="_blank" rel="noopener noreferrer">qalita.io</a>
      </div>
    </div>
  </div>
  <script>
    (function(){
      fetch('/static/version.json').then(r=>r.json()).then(v=>{
        const el=document.getElementById('cli_version'); if(el){ el.textContent = (v && v.version) ? `CLI v${v.version}` : ''; }
      }).catch(()=>{});
    })();
  </script>
</body>

</html>