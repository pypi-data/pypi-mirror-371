variables:
  - &ci_image 'cont-reg.bjodah.se:443/bjodah/triceratops-3:34'

when:
  - event: [push]  # pull_request, tag, cron, 

steps:
  - name: pypy
    image: *ci_image
    commands:
      - bash -l .ci/test-case.sh --tmp --python /opt-3/pypy3.*-linux64/bin/python3 --sundials-dir /opt-3/sundials-6.7.0-debug

  - name: py3.11-rel
    image: *ci_image
    commands:
      - bash -l .ci/test-case.sh --tmp --python /opt-3/cpython-v3.11.*-release/bin/python3 --sundials-dir /opt-3/sundials-6.7.0-debug

  - name: py3.12-asan
    image: *ci_image
    environment:
      - PYTHONMALLOC=malloc
      - CXXFLAGS=-U_NDEBUG -UNDEBUG -Og -ggdb3
    commands:
      - bash -l .ci/test-case.sh --asan --tmp --python /opt-3/cpython-v3.12.*-release/bin/python3 --sundials-dir /opt-3/sundials-6.7.0-debug

  - name: py3.13-release
    image: *ci_image
    environment:
      - PYKINSOL_NO_LAPACK=1
      - PYKINSOL_NO_KLU=1
    commands:
      - bash -lc "source /opt-3/cpython-v3.13*-apt-deb/bin/activate; .ci/test-case.sh --tmp --asan --sundials-dir /opt-3/sundials-6.7.0-release"

  # - name: py3.11-debug
  #   image: *ci_image
  #   environment:
  #     - PYKINSOL_NO_LAPACK=1
  #     - PYKINSOL_NO_KLU=1
  #   commands:
  #     - .ci/test-case.sh --tmp --python /opt-3/cpython-v3.11.*-debug/bin/python3 --sundials-dir /opt-3/sundials-6.7.0-debug

  - name: sdist-and-docs
    image: *ci_image
    environment:
      - PYKINSOL_STRICT=1
      - LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu
    commands:
      #- git fetch -tq
      # - bash -c '[[ $(python3 setup.py --version 2>/dev/null) =~ ^[0-9]+.* ]]'
      - bash -l .ci/test-sdist.sh
      - ./scripts/prepare_deploy.sh
      - ./scripts/grep-for-merge-blocking-token.sh
    depends_on:
      - pypy
      - py3.11-rel
      - py3.12-asan
      - py3.13-release
      #- py3.11-debug

  - name: deploy-public-html
    image: *ci_image
    commands:
      - tar -C ./deploy/public_html -czf pykinsol-${CI_COMMIT_BRANCH}.tar.gz .
      - curl -T pykinsol-${CI_COMMIT_BRANCH}.tar.gz ftp://pykinsol:$${ARTIFACTS_PASS}@$${FTP_SERVER}/public_html/
    secrets: [ ARTIFACTS_PASS, FTP_SERVER ]
    when:
     - event: push
       repo: bjodah/pykinsol
    depends_on:
      - sdist-and-docs
